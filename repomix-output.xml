This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
Dockerfile
index.html
package.json
public/vite.svg
README.md
src/api/index.ts
src/App.vue
src/assets/vue.svg
src/components/TaskAnalyzer.vue
src/layouts/AdminLayout.vue
src/main.ts
src/router/index.ts
src/store/task.ts
src/style.css
src/types/index.ts
src/utils/logger.ts
src/views/Login.vue
src/views/Signup.vue
src/views/StandardFieldList.vue
src/views/TaskManagement.vue
src/views/UserManagement.vue
src/views/UserSearch.vue
src/views/WordRootList.vue
tsconfig.app.json
tsconfig.json
tsconfig.node.json
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="Dockerfile">
FROM nginx:alpine
# 拷贝 Nginx 配置（见下方第 4 点）
COPY ./default.conf /etc/nginx/conf.d/default.conf
# 拷贝构建好的静态资源
COPY ./dist /usr/share/nginx/html
EXPOSE 80
</file>

<file path="index.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>data-dict-frontend</title>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
</file>

<file path="public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="src/assets/vue.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="37.07" height="36" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 198"><path fill="#41B883" d="M204.8 0H256L128 220.8L0 0h97.92L128 51.2L157.44 0h47.36Z"></path><path fill="#41B883" d="m0 0l128 220.8L256 0h-51.2L128 132.48L50.56 0H0Z"></path><path fill="#35495E" d="M50.56 0L128 133.12L204.8 0h-47.36L128 51.2L97.92 0H50.56Z"></path></svg>
</file>

<file path="src/store/task.ts">
import { defineStore } from 'pinia';
import { dictionaryApi } from '../api';
import { logger } from '../utils/logger';

export const useTaskStore = defineStore('task', {
  state: () => ({
    unprocessedCount: 0,
  }),
  actions: {
    async refreshCount() {
      try {
        const { data } = await dictionaryApi.getTaskCount();
        this.unprocessedCount = data.count;
        logger.debug("Store:Task", "未处理任务数已更新", data.count);
      } catch (e) {
        logger.error("Store:Task", "更新任务数失败", e);
      }
    }
  }
});
</file>

<file path="src/style.css">
:root {
  font-family: system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-weight: 400;

  color-scheme: light dark;
  color: rgba(255, 255, 255, 0.87);
  background-color: #242424;

  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

a {
  font-weight: 500;
  color: #646cff;
  text-decoration: inherit;
}
a:hover {
  color: #535bf2;
}

body {
  margin: 0;
  display: flex;
  place-items: center;
  min-width: 320px;
  min-height: 100vh;
}

h1 {
  font-size: 3.2em;
  line-height: 1.1;
}

button {
  border-radius: 8px;
  border: 1px solid transparent;
  padding: 0.6em 1.2em;
  font-size: 1em;
  font-weight: 500;
  font-family: inherit;
  background-color: #1a1a1a;
  cursor: pointer;
  transition: border-color 0.25s;
}
button:hover {
  border-color: #646cff;
}
button:focus,
button:focus-visible {
  outline: 4px auto -webkit-focus-ring-color;
}

.card {
  padding: 2em;
}

#app {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

@media (prefers-color-scheme: light) {
  :root {
    color: #213547;
    background-color: #ffffff;
  }
  a:hover {
    color: #747bff;
  }
  button {
    background-color: #f9f9f9;
  }
}
</file>

<file path="src/utils/logger.ts">
// src/utils/logger.ts

// 使用普通对象代替 enum，满足 erasableSyntaxOnly 要求
const LogLevel = {
  DEBUG: 0,
  INFO: 1,
  WARN: 2,
  ERROR: 3
} as const;

type LogLevelValue = typeof LogLevel[keyof typeof LogLevel];

// 自动判断开发环境或生产环境
const CURRENT_LEVEL: LogLevelValue = import.meta.env.DEV ? LogLevel.DEBUG : LogLevel.WARN;

const styles = {
  DEBUG: "color: #909399; font-weight: bold;",
  INFO: "color: white; background: #409eff; padding: 2px 5px; border-radius: 3px;",
  WARN: "color: white; background: #e6a23c; padding: 2px 5px; border-radius: 3px;",
  ERROR: "color: white; background: #f56c6c; padding: 2px 5px; border-radius: 3px;",
  TAG: "color: #409eff; font-weight: bold; margin-left: 5px;"
};

export const logger = {
  debug: (tag: string, msg: string, data: unknown = "") => {
    if (CURRENT_LEVEL <= LogLevel.DEBUG) {
      console.log(`%c[DEBUG]%c %c${tag}%c ${msg}`, styles.DEBUG, "", styles.TAG, "", data);
    }
  },
  info: (tag: string, msg: string, data: unknown = "") => {
    if (CURRENT_LEVEL <= LogLevel.INFO) {
      console.log(`%c[INFO]%c %c${tag}%c ${msg}`, styles.INFO, "", styles.TAG, "", data);
    }
  },
  warn: (tag: string, msg: string, data: unknown = "") => {
    if (CURRENT_LEVEL <= LogLevel.WARN) {
      console.warn(`%c[WARN]%c %c${tag}%c ${msg}`, styles.WARN, "", styles.TAG, "", data);
    }
  },
  error: (tag: string, msg: string, err: unknown = "") => {
    if (CURRENT_LEVEL <= LogLevel.ERROR) {
      console.error(`%c[ERROR]%c %c${tag}%c ${msg}`, styles.ERROR, "", styles.TAG, "", err);
    }
  }
};
</file>

<file path="src/views/Signup.vue">
<template>
  <div class="signup-container">
    <el-card class="signup-card">
      <template #header><h2>新管理员注册申请</h2></template>
      <el-form :model="form">
        <el-form-item>
          <el-input v-model="form.username" placeholder="设置用户名" prefix-icon="User" />
        </el-form-item>
        <el-form-item>
          <el-input v-model="form.password" type="password" placeholder="设置密码" show-password prefix-icon="Lock" />
        </el-form-item>
        <el-button type="success" @click="handleSignup" :loading="loading" style="width: 100%">
          提交注册
        </el-button>
        <div class="link">
          <el-button link @click="$router.push('/login')">已有账号？去登录</el-button>
        </div>
      </el-form>
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { reactive, ref } from 'vue';
import { dictionaryApi } from '../api';
import { useRouter } from 'vue-router';
import { ElMessage } from 'element-plus';

const router = useRouter();
const loading = ref(false);
const form = reactive({ username: '', password: '' });

const handleSignup = async () => {
  loading.value = true;
  try {
    await dictionaryApi.signup(form);
    ElMessage.success('注册成功，请联系系统管理员通过审核（或手动改DB角色）');
    router.push('/login');
  } catch (e: any) {
    ElMessage.error(e.response?.data || '注册失败');
  } finally {
    loading.value = false;
  }
};
</script>

<style scoped>
.signup-container { height: 100vh; display: flex; justify-content: center; align-items: center; background: #2d3a4b; }
.signup-card { width: 400px; }
.link { text-align: center; margin-top: 15px; }
</style>
</file>

<file path="src/views/TaskManagement.vue">
<template>
  <div class="task-container">
    <el-card shadow="never">
      <template #header>
        <div class="header">
          <span class="title">用户需求待办列表</span>
          <el-tag type="danger">{{ tasks.length }} 条待处理</el-tag>
        </div>
      </template>

      <el-table :data="tasks" border v-loading="loading">
        <el-table-column label="申请时间" width="180">
          <template #default="{ row }">
            {{ new Date(row.created_at).toLocaleString() }}
          </template>
        </el-table-column>
        
        <el-table-column label="申请字段名" prop="payload.field_cn_name" width="200" />

        <el-table-column label="智能分词分析 (自动匹配当前词根库)">
          <template #default="{ row }">
            <TaskAnalyzer :cn-name="row.payload.field_cn_name" />
          </template>
        </el-table-column>

        <el-table-column label="操作" width="150" align="center">
          <template #default="{ row }">
            <el-button type="success" size="small" @click="handleDone(row.id)">标记处理</el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { dictionaryApi } from '../api';
import { ElMessage } from 'element-plus';
import TaskAnalyzer from '../components/TaskAnalyzer.vue'; // 提取的分析组件
import { useTaskStore } from '../store/task';

const taskStore = useTaskStore();
const tasks = ref<any[]>([]);
const loading = ref(false);

const fetchTasks = async () => {
  loading.value = true;
  try {
    const { data } = await dictionaryApi.getTasks();
    tasks.value = data;
  } finally { loading.value = false; }
};

const handleDone = async (id: number) => {
  try {
    await dictionaryApi.completeTask(id);
    ElMessage.success("已标记为已处理");
    
    // 关键：处理完后，立即让左侧菜单更新数字
    await taskStore.refreshCount();
    await fetchTasks(); // 刷新当前列表
  } catch (e) {
    ElMessage.error("操作失败");
  }
};

onMounted(fetchTasks);
</script>
</file>

<file path="src/views/UserManagement.vue">
<template>
  <div class="user-management-container">
    <el-card shadow="never" class="main-card">
      <!-- 头部操作区 -->
      <template #header>
        <div class="card-header">
          <div class="title-group">
            <span class="title">用户权限管理</span>
            <el-tag type="info" size="small" class="ml-2">总计 {{ users.length }} 名用户</el-tag>
          </div>
          <el-button type="primary" :icon="Plus" @click="openAddDialog">
            开通新账号
          </el-button>
        </div>
      </template>

      <!-- 用户数据表格 -->
      <el-table :data="users" border v-loading="loading" style="width: 100%">
        <el-table-column prop="id" label="ID" width="80" align="center" />
        <el-table-column prop="username" label="登录账号" min-width="150" />
        
        <el-table-column label="当前角色" width="150" align="center">
          <template #default="{ row }">
            <el-tag :type="row.role === 'admin' ? 'danger' : 'info'" effect="dark">
              {{ row.role === 'admin' ? '超级管理员' : '普通用户' }}
            </el-tag>
          </template>
        </el-table-column>

        <el-table-column prop="created_at" label="注册时间" width="200">
          <template #default="{ row }">
            {{ row.created_at ? new Date(row.created_at).toLocaleString() : '-' }}
          </template>
        </el-table-column>

        <el-table-column label="权限及账号操作" width="280" fixed="right">
          <template #default="{ row }">
            <!-- 角色切换：不能降权自己（建议在生产环境增加此逻辑） -->
            <el-button 
              v-if="row.role !== 'admin'" 
              link 
              type="warning" 
              @click="handleRoleChange(row, 'admin')"
            >
              设为管理员
            </el-button>
            <el-button 
              v-else 
              link 
              type="info" 
              @click="handleRoleChange(row, 'user')"
            >
              降为普通用户
            </el-button>

            <el-divider direction="vertical" />

            <!-- 删除操作 -->
            <el-popconfirm 
              :title="`确定要永久删除用户 [${row.username}] 吗？`"
              confirm-button-text="确定"
              cancel-button-text="取消"
              @confirm="handleDelete(row.id)"
            >
              <template #reference>
                <el-button link type="danger">注销账号</el-button>
              </template>
            </el-popconfirm>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <!-- 新增用户对话框 -->
    <el-dialog 
      v-model="addDialogVisible" 
      title="开通内部员工账号" 
      width="450px"
      @closed="resetAddForm"
      destroy-on-close
    >
      <el-form 
        :model="addForm" 
        ref="addFormRef" 
        :rules="addRules" 
        label-width="80px"
        label-position="top"
      >
        <el-form-item label="登录用户名" prop="username">
          <el-input v-model="addForm.username" placeholder="建议使用姓名拼音" />
        </el-form-item>
        
        <el-form-item label="初始登录密码" prop="password">
          <el-input 
            v-model="addForm.password" 
            type="password" 
            show-password 
            placeholder="请设置至少6位密码" 
          />
        </el-form-item>

        <el-form-item label="分配初始角色" prop="role">
          <el-radio-group v-model="addForm.role">
            <el-radio label="user" border>普通用户 (仅查询)</el-radio>
            <el-radio label="admin" border>管理员 (增删改)</el-radio>
          </el-radio-group>
        </el-form-item>
      </el-form>

      <template #footer>
        <div class="dialog-footer">
          <el-button @click="addDialogVisible = false">取消</el-button>
          <el-button type="primary" @click="submitAddUser" :loading="addLoading">
            确认创建
          </el-button>
        </div>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue';
import { Plus } from '@element-plus/icons-vue';
import { dictionaryApi } from '../api';
import { ElMessage, ElMessageBox } from 'element-plus';

// --- 基础状态 ---
const users = ref<any[]>([]);
const loading = ref(false);

// --- 新增用户相关 ---
const addDialogVisible = ref(false);
const addLoading = ref(false);
const addFormRef = ref();
const addForm = reactive({
  username: '',
  password: '',
  role: 'user'
});

const addRules = {
  username: [
    { required: true, message: '用户名不能为空', trigger: 'blur' },
    { min: 3, message: '用户名至少3位', trigger: 'blur' }
  ],
  password: [
    { required: true, message: '密码不能为空', trigger: 'blur' },
    { min: 6, message: '密码至少6位', trigger: 'blur' }
  ],
  role: [
    { required: true, message: '请选择角色权限', trigger: 'change' }
  ]
};

// --- 核心方法 ---

// 1. 加载用户列表
const fetchUsers = async () => {
  loading.value = true;
  try {
    const { data } = await dictionaryApi.getUsers();
    users.value = data;
  } catch (error) {
    console.error("加载用户失败", error);
  } finally {
    loading.value = false;
  }
};

// 2. 打开新增弹窗
const openAddDialog = () => {
  addDialogVisible.value = true;
};

// 3. 提交创建请求
const submitAddUser = async () => {
  if (!addFormRef.value) return;
  
  await addFormRef.value.validate(async (valid: boolean) => {
    if (valid) {
      addLoading.value = true;
      try {
        await dictionaryApi.adminCreateUser(addForm);
        ElMessage.success(`用户 ${addForm.username} 创建成功`);
        addDialogVisible.value = false;
        await fetchUsers(); // 刷新列表
      } catch (error: any) {
        ElMessage.error(error.response?.data || '创建失败，请检查用户名是否重复');
      } finally {
        addLoading.value = false;
      }
    }
  });
};

// 4. 修改用户角色
const handleRoleChange = (row: any, newRole: string) => {
  const roleName = newRole === 'admin' ? '管理员' : '普通用户';
  
  ElMessageBox.confirm(
    `确认将用户 [${row.username}] 的角色修改为 [${roleName}] 吗？`,
    '权限变更确认',
    { type: 'warning' }
  ).then(async () => {
    try {
      await dictionaryApi.updateUserRole(row.id, newRole);
      ElMessage.success('权限更新成功');
      await fetchUsers();
    } catch (e) {
      ElMessage.error('权限更新失败');
    }
  }).catch(() => {});
};

// 5. 删除用户
const handleDelete = async (id: number) => {
  try {
    await dictionaryApi.deleteUser(id);
    ElMessage.success('用户账号已注销');
    await fetchUsers();
  } catch (e) {
    ElMessage.error('删除操作失败');
  }
};

// 重置表单
const resetAddForm = () => {
  addForm.username = '';
  addForm.password = '';
  addForm.role = 'user';
  if (addFormRef.value) addFormRef.value.resetFields();
};

onMounted(fetchUsers);
</script>

<style scoped>
.user-management-container {
  padding: 10px;
}

.main-card {
  border-radius: 8px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.title-group {
  display: flex;
  align-items: center;
}

.title {
  font-size: 16px;
  font-weight: bold;
  color: #303133;
}

.ml-2 {
  margin-left: 8px;
}

.dialog-footer {
  display: flex;
  justify-content: flex-end;
}

/* 让单选框组美观一点 */
:deep(.el-radio.is-bordered) {
  margin-right: 10px;
  margin-bottom: 10px;
}
</style>
</file>

<file path="tsconfig.app.json">
{
  "extends": "@vue/tsconfig/tsconfig.dom.json",
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "types": ["vite/client"],

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src/**/*.ts", "src/**/*.tsx", "src/**/*.vue"]
}
</file>

<file path="tsconfig.json">
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}
</file>

<file path="tsconfig.node.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true,
    
    "allowSyntheticDefaultImports": true,
    "composite": true,
  },
  "include": ["vite.config.ts"]
}
</file>

<file path="vite.config.ts">
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  server: {
    proxy: {
      '/api': {
        target: 'http://127.0.0.1:3000',
        changeOrigin: true,
      }
    }
  }
})
</file>

<file path="README.md">
企业级元数据管理的标准流程：“用户消费数据、管理员生产标准”

系统划分为两个核心视图：【用户查询端】 和 【管理员管理端】

业务逻辑流程图
用户视角 (查询逻辑)：
输入中文名 -> 后端查询 standard_fields (标准字段库)。
命中：展示对应的英文名、数据类型。
未命中：红色警告“未找到标准定义”，提供一个【申请新增】按钮。
点击申请：向 notification_tasks 写入一条任务。
管理员视角 (生产逻辑)：
进入“智能命名” -> 输入中文 -> 系统调用 jieba 分词。
全匹配：所有分词都有词根 -> 自动组合英文名 -> 允许点击【正式入库】。
部分缺失：存在无词根的词段 -> 禁止入库 -> 引导管理员先去【新增词根】。
</file>

<file path="src/components/TaskAnalyzer.vue">
<template>
  <div class="analyzer-tags">
    <template v-if="segments.length > 0">
      <div v-for="(seg, index) in segments" :key="index" class="segment-wrapper">
        
        <!-- 情况 A: 匹配到词根 (绿色) -->
        <template v-if="seg.isMatched">
          <el-tooltip 
            placement="top" 
            effect="light" 
            :disabled="seg.allCandidates.length <= 1"
          >
            <!-- 悬浮展示所有候选词根 -->
            <template #content>
              <div class="candidate-tip-title">可选词根 (共 {{ seg.allCandidates.length }} 个):</div>
              <div v-for="c in seg.allCandidates" :key="c.id" class="candidate-tip-item">
                <el-tag size="small" type="info" class="mr-5">{{ c.en_abbr }}</el-tag>
                <span>{{ c.cn_name }}</span>
                <span v-if="c.en_full_name" class="full-name"> - {{ c.en_full_name }}</span>
              </div>
            </template>

            <!-- 主展示标签 -->
            <el-badge 
              :value="seg.allCandidates.length" 
              :hidden="seg.allCandidates.length <= 1"
              type="warning"
              is-dot
              class="badge-item"
            >
              <el-tag 
                type="success" 
                :effect="seg.allCandidates.length > 1 ? 'light' : 'plain'" 
                class="word-tag"
                :class="{ 'has-multiple': seg.allCandidates.length > 1 }"
              >
                {{ seg.primaryEn }} <span class="cn-hint">({{ seg.text }})</span>
              </el-tag>
            </el-badge>
          </el-tooltip>
        </template>

        <!-- 情况 B: 缺失词根 (红色) -->
        <el-tag v-else type="danger" effect="dark" class="word-tag">
          {{ seg.text }} (缺失)
        </el-tag>

      </div>
    </template>
    <div v-else-if="loading" class="loading-text">智能分析中...</div>
    <div v-else class="loading-text">分析无结果</div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { dictionaryApi } from '../api';
import { logger } from '../utils/logger';

const props = defineProps<{ cnName: string }>();
const segments = ref<any[]>([]);
const loading = ref(true);

onMounted(async () => {
  try {
    const { data } = await dictionaryApi.getSuggest(props.cnName);
    
    if (data.segments) {
      segments.value = data.segments.map((seg: any) => {
        const candidates = seg.candidates || [];
        const isMatched = candidates.length > 0;
        return {
          text: seg.word,
          isMatched: isMatched,
          primaryEn: isMatched ? candidates[0].en_abbr : '', // 默认显示第一个
          allCandidates: candidates // 保存所有候选，供 Tooltip 使用
        };
      });
      logger.debug("TaskAnalyzer", `分析完成: ${props.cnName}`, segments.value);
    }
  } catch (e) {
    logger.error("TaskAnalyzer", "分析失败", e);
  } finally {
    loading.value = false;
  }
});
</script>

<style scoped>
.analyzer-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 12px; /* 增加间距防止 Badge 重叠 */
  align-items: center;
}

.segment-wrapper {
  display: inline-block;
  vertical-align: middle;
}

.word-tag {
  font-weight: bold;
  font-family: 'Consolas', monospace;
  transition: all 0.2s;
}

/* 如果有多个候选，给标签加一个虚线边框增加辨识度 */
.word-tag.has-multiple {
  border-style: dashed;
}

.cn-hint {
  font-size: 10px;
  opacity: 0.8;
  font-weight: normal;
}

/* 气泡样式 */
.candidate-tip-title {
  font-weight: bold;
  margin-bottom: 8px;
  border-bottom: 1px solid #eee;
  padding-bottom: 4px;
  color: #606266;
}

.candidate-tip-item {
  margin-bottom: 4px;
  font-size: 13px;
}

.mr-5 {
  margin-right: 8px;
}

.full-name {
  color: #999;
  font-size: 11px;
}

.loading-text {
  font-size: 12px;
  color: #909399;
  font-style: italic;
}

/* 修正 Badge 位置 */
.badge-item :deep(.el-badge__content.is-fixed.is-dot) {
  right: 2px;
  top: 4px;
}
</style>
</file>

<file path="src/views/Login.vue">
<template>
  <div class="login-container">
    <el-card class="login-card">
      <template #header>
        <div class="login-title">数据标准系统登录</div>
      </template>

      <el-form :model="form" @keyup.enter="handleLogin">
        <el-form-item>
          <!-- 这里使用图标组件 -->
          <el-input v-model="form.username" placeholder="用户名">
            <template #prefix><el-icon>
                <User />
              </el-icon></template>
          </el-input>
        </el-form-item>

        <el-form-item>
          <el-input v-model="form.password" type="password" placeholder="密码" show-password>
            <template #prefix><el-icon>
                <Lock />
              </el-icon></template>
          </el-input>
        </el-form-item>

        <el-button type="primary" :loading="loading" @click="handleLogin" class="w-full">
          登录系统
        </el-button>
      </el-form>
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { reactive, ref } from 'vue';
import { dictionaryApi } from '../api';
import { useRouter } from 'vue-router';
import { ElMessage } from 'element-plus';
// 确保这些图标被模板用到
import { User, Lock } from '@element-plus/icons-vue';

const router = useRouter();
const loading = ref(false);

const form = reactive({
  username: '',
  password: ''
});

const handleLogin = async () => {
  if (!form.username || !form.password) {
    ElMessage.warning('请完整填写信息');
    return;
  }

  loading.value = true;
  try {
    const { data } = await dictionaryApi.login(form);

    // 核心：存储凭证
    localStorage.setItem('token', data.token);
    localStorage.setItem('role', data.role);

    ElMessage.success('欢迎回来');

    if (data.role === 'admin') {
      // 管理员去后台
      router.push('/admin/fields');
    } else {
      // 普通用户去查询页
      router.push('/');
    }
  } catch (error: any) {
    console.error(error);
    ElMessage.error(error.response?.data || '登录验证失败');
  } finally {
    loading.value = false;
  }
};
</script>

<style scoped>
.login-container {
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: #2d3a4b;
}

.login-card {
  width: 400px;
}

.login-title {
  text-align: center;
  font-size: 18px;
  font-weight: bold;
}

.w-full {
  width: 100%;
}
</style>
</file>

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
*.xml
</file>

<file path="package.json">
{
  "name": "data-dict-frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vue-tsc -b && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@element-plus/icons-vue": "^2.3.2",
    "axios": "^1.13.2",
    "element-plus": "^2.13.1",
    "pinia": "^3.0.4",
    "vue": "^3.5.24",
    "vue-router": "^4.6.4",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@types/node": "^24.10.1",
    "@vitejs/plugin-vue": "^6.0.3",
    "@vue/tsconfig": "^0.8.1",
    "typescript": "~5.9.3",
    "vite": "^7.2.4",
    "vue-tsc": "^3.1.4"
  }
}
</file>

<file path="src/App.vue">
<template>
  <!-- 全局根视图出口 -->
  <router-view />
</template>

<script setup lang="ts">
// 根组件不再处理业务逻辑
</script>

<style>
body { margin: 0; padding: 0; background-color: #f0f2f5; }
</style>
</file>

<file path="src/main.ts">
import { createApp } from 'vue'
import App from './App.vue'
import router from './router' // 引入路由
import ElementPlus from 'element-plus'
import 'element-plus/dist/index.css'
import { createPinia } from 'pinia'

const app = createApp(App)
app.use(router) // 使用路由
app.use(ElementPlus)
app.use(createPinia())
app.mount('#app')
</file>

<file path="src/router/index.ts">
import { createRouter, createWebHistory, type RouteRecordRaw } from 'vue-router';

// 定义路由规则
const routes: Array<RouteRecordRaw> = [
  // 1. 公共入口：用户查询门户
  {
    path: '/',
    name: 'UserSearch',
    component: () => import('../views/UserSearch.vue'),
    meta: { title: '标准查询门户' }
  },

  // 2. 身份认证页
  {
    path: '/login',
    name: 'Login',
    component: () => import('../views/Login.vue'),
    meta: { title: '系统登录' }
  },
  {
    path: '/signup',
    name: 'Signup',
    component: () => import('../views/Signup.vue'),
    meta: { title: '用户注册' }
  },

  // 3. 管理员后台（嵌套路由）
  {
    path: '/admin',
    component: () => import('../layouts/AdminLayout.vue'),
    redirect: '/admin/fields', // 访问 /admin 时自动跳转到字段管理
    meta: { requiresAuth: true, requiresAdmin: true }, // 标记需要权限
    children: [
      {
        path: 'fields',
        name: 'StandardFieldList',
        component: () => import('../views/StandardFieldList.vue'),
        meta: { title: '标准字段管理' }
      },
      {
        path: 'roots',
        name: 'WordRootList',
        component: () => import('../views/WordRootList.vue'),
        meta: { title: '标准词根管理' }
      },
      {
        path: 'tasks',
        name: 'TaskManagement',
        component: () => import('../views/TaskManagement.vue'),
        meta: { title: '用户需求待办' }
      },
      {
        path: 'users',
        name: 'UserManagement',
        component: () => import('../views/UserManagement.vue'),
        meta: { title: '用户权限管理' }
      }
    ]
  },

  // 4. 404 兜底（可选）
  {
    path: '/:pathMatch(.*)*',
    redirect: '/'
  }
];

const router = createRouter({
  history: createWebHistory(),
  routes
});

/**
 * 全局路由守卫
 * 负责：页面标题更新、登录拦截、角色权限控制
 */
router.beforeEach((to, _from, next) => {
  // 1. 动态更新浏览器页签标题
  if (to.meta.title) {
    document.title = `${to.meta.title} - 数据字典系统`;
  }

  // 2. 获取本地存储的登录状态
  const token = localStorage.getItem('token');
  const role = localStorage.getItem('role');

  // 3. 权限判断逻辑
  if (to.matched.some(record => record.meta.requiresAuth)) {
    // 检查是否登录
    if (!token) {
      next({
        path: '/login',
        query: { redirect: to.fullPath } // 登录后跳转回当前页
      });
    }
    // 检查是否是管理员角色
    else if (to.matched.some(record => record.meta.requiresAdmin) && role !== 'admin') {
      // 如果不是管理员，强制踢回普通查询页
      alert('权限不足：您的账号不是管理员角色，无法进入后台。');
      next('/');
    }
    else {
      next(); // 验证通过
    }
  } else {
    // 公共页面，如果已登录且访问 login 页，直接跳后台
    if (to.path === '/login' && token && role === 'admin') {
      next('/admin/fields');
    } else {
      next();
    }
  }
});

export default router;
</file>

<file path="src/layouts/AdminLayout.vue">
<template>
  <el-container class="admin-layout">
    <!-- 左侧导航 -->
    <el-aside width="240px" class="aside-menu">
      <div class="logo-box">
        <el-icon class="logo-icon">
          <DataLine />
        </el-icon>
        <span class="logo-text">字典管理系统</span>
      </div>

      <el-menu :default-active="activePath" class="el-menu-vertical" background-color="#304156" text-color="#bfcbd9"
        active-text-color="#409EFF" router>
        
        <el-menu-item index="/admin/fields">
          <el-icon><DataAnalysis /></el-icon>
          <span>标准字段管理</span>
        </el-menu-item>

        <el-menu-item index="/admin/roots">
          <el-icon><Collection /></el-icon>
          <span>标准词根库</span>
        </el-menu-item>

        <!-- 优化后的菜单项 -->
        <el-menu-item index="/admin/tasks" class="task-menu-item">
          <el-icon><Bell /></el-icon>
          <span class="menu-label">用户需求待办</span>
          <el-badge 
            v-if="taskStore.unprocessedCount > 0" 
            :value="taskStore.unprocessedCount" 
            :max="99"
            type="danger" 
            class="custom-badge"
          />
        </el-menu-item>

        <el-menu-item index="/admin/users">
          <el-icon><UserFilled /></el-icon>
          <span>用户权限管理</span>
        </el-menu-item>

      </el-menu>
    </el-aside>

    <el-container>
      <!-- 顶栏 -->
      <el-header class="admin-header">
        <div class="header-left">
          <el-breadcrumb separator="/">
            <el-breadcrumb-item :to="{ path: '/' }">首页</el-breadcrumb-item>
            <el-breadcrumb-item>{{ currentRouteTitle }}</el-breadcrumb-item>
          </el-breadcrumb>
        </div>

        <!-- 退出登录区域 -->
        <div class="header-right">
          <el-dropdown @command="handleCommand" trigger="click">
            <span class="user-info">
              <span class="username">管理员</span>
              <el-icon class="el-icon--right"><arrow-down /></el-icon>
            </span>
            <template #dropdown>
              <el-dropdown-menu>
                <el-dropdown-item divided command="logout" class="logout-item">
                  <el-icon>
                    <SwitchButton />
                  </el-icon>退出登录
                </el-dropdown-item>
              </el-dropdown-menu>
            </template>
          </el-dropdown>
        </div>
      </el-header>

      <!-- 主内容 -->
      <el-main class="admin-main">
        <router-view v-slot="{ Component }">
          <transition name="fade-transform" mode="out-in">
            <keep-alive>
              <component :is="Component" />
            </keep-alive>
          </transition>
        </router-view>
      </el-main>
    </el-container>
  </el-container>
</template>

<script setup lang="ts">
import { computed, onMounted } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import { useTaskStore } from '../store/task';
import {
  DataAnalysis,
  Collection,
  DataLine,
  UserFilled,
  ArrowDown,
  SwitchButton,
  Bell
} from '@element-plus/icons-vue';
import { ElMessageBox, ElMessage } from 'element-plus';

const route = useRoute();
const router = useRouter();
const taskStore = useTaskStore();

const activePath = computed(() => route.path);
const currentRouteTitle = computed(() => route.meta.title || '后台管理');

const handleCommand = (command: string) => {
  if (command === 'logout') handleLogout();
};

const handleLogout = () => {
  ElMessageBox.confirm('确认退出系统管理后台吗？', '提示', {
    confirmButtonText: '确定',
    cancelButtonText: '取消',
    type: 'warning',
  }).then(() => {
    localStorage.removeItem('token');
    localStorage.removeItem('role');
    ElMessage.success('已安全退出');
    router.push('/login');
  }).catch(() => {});
};

onMounted(() => {
  taskStore.refreshCount();
  setInterval(() => {
    taskStore.refreshCount();
  }, 30000);
});
</script>

<style scoped>
.admin-layout { height: 100vh; }
.aside-menu { background-color: #304156; transition: width 0.3s; }
.logo-box { 
  height: 60px; display: flex; align-items: center; justify-content: center; 
  background: #2b2f3a; color: #fff; 
}
.logo-icon { font-size: 24px; color: #409EFF; margin-right: 10px; }
.logo-text { font-size: 16px; font-weight: bold; }
.el-menu-vertical { border-right: none; }
.admin-header { 
  background: #fff; border-bottom: 1px solid #e6e6e6; 
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px; height: 60px;
}
.user-info { display: flex; align-items: center; cursor: pointer; padding: 5px 8px; border-radius: 4px; }
.username { font-size: 14px; color: #606266; margin-right: 4px; }
.logout-item { color: #f56c6c; }
.admin-main { background-color: #f0f2f5; padding: 20px; }

/* 页面切换动画 */
.fade-transform-enter-active, .fade-transform-leave-active { transition: all 0.3s; }
.fade-transform-enter-from { opacity: 0; transform: translateX(-20px); }
.fade-transform-leave-to { opacity: 0; transform: translateX(20px); }

/* --- 菜单 Badge 深度优化样式 --- */

/* 强制让菜单项内容变为水平对齐 */
.task-menu-item :deep(.el-menu-item-content) {
  display: flex !important;
  align-items: center !important;
  width: 100%;
}

/* 撑开文字，让 Badge 靠右 */
.menu-label {
  flex: 1;
}

/* 核心对齐逻辑：取消 Badge 的绝对定位和偏移 */
.custom-badge {
  display: flex;
  align-items: center;
  margin-right: 15px; /* 距离右侧边缘的间距 */
}

/* 关键：重置 Element Plus 默认的右上角定位 */
.custom-badge :deep(.el-badge__content) {
  position: relative !important;
  top: auto !important;
  right: auto !important;
  transform: none !important; /* 彻底取消 translate 偏移 */
  border: none; /* 去除白边 */
  height: 18px;
  line-height: 18px;
  padding: 0 6px;
  font-size: 12px;
  background-color: #f56c6c;
}
</style>
</file>

<file path="src/types/index.ts">
export interface AuthPayload {
  username: string;
  password: string;
}

export interface AuthResponse {
  token: string;
  role: string;
}

export interface WordRoot {
  id?: number;
  cn_name: string;
  en_abbr: string;
  en_full_name?: string;
  associated_terms?: string;
  remark?: string;
  created_at?: string;
  score?: number;
}

export interface Segment {
  word: string;
  candidates: WordRoot[];
}

export interface SuggestResponse {
  segments: Segment[];
}

export interface StandardField {
  id?: number;
  field_cn_name: string;
  field_en_name: string;
  composition_ids: number[];
  data_type: string;
  associated_terms?: string;
  is_standard: boolean;
  created_at?: string;
  score?: number;
}
</file>

<file path="src/views/WordRootList.vue">
<template>
  <div class="root-container">
    <!-- 操作栏 -->
    <div class="toolbar">
      <div class="left">
        <el-input v-model="searchQuery" placeholder="搜索中文名或英文缩写" style="width: 300px" clearable @input="handleSearch"
          :prefix-icon="Search" />
      </div>
      <div class="right">
        <!-- 一键清空按钮 -->
        <el-button type="danger" plain :icon="Delete" @click="handleClearAll">
          清空所有
        </el-button>

        <el-divider direction="vertical" />

        <el-button type="success" :icon="Download" @click="handleExport">
          导出 Excel
        </el-button>

        <el-upload action="" :auto-upload="false" :show-file-list="false" accept=".xlsx, .xls" :on-change="handleImport"
          style="display: inline-block; margin: 0 8px">
          <el-button type="warning" :icon="Upload">导入 Excel</el-button>
        </el-upload>

        <el-button type="primary" :icon="Plus" @click="openAddDialog">
          新增词根
        </el-button>
      </div>
    </div>

    <!-- 数据表格 -->
    <el-table :data="roots" border v-loading="loading" style="width: 100%">
      <el-table-column prop="id" label="ID" width="80" align="center" />
      <el-table-column prop="cn_name" label="中文名称" width="150" />
      <el-table-column prop="en_full_name" label="英文全称" width="180" show-overflow-tooltip />
      <el-table-column prop="en_abbr" label="英文缩写" width="150" align="center">
        <template #default="{ row }">
          <code class="en-code">{{ row.en_abbr }}</code>
        </template>
      </el-table-column>
      <el-table-column prop="associated_terms" label="同义词" show-overflow-tooltip />
      <el-table-column prop="remark" label="备注" show-overflow-tooltip />
      <el-table-column prop="created_at" label="创建时间" width="180">
        <template #default="{ row }">
          {{ row.created_at ? new Date(row.created_at).toLocaleString() : '-' }}
        </template>
      </el-table-column>

      <el-table-column label="操作" width="150" fixed="right" align="center">
        <template #default="{ row }">
          <el-button link type="primary" @click="handleEdit(row)">编辑</el-button>
          <el-popconfirm title="确定删除吗？" @confirm="handleDelete(row.id)">
            <template #reference>
              <el-button link type="danger">删除</el-button>
            </template>
          </el-popconfirm>
        </template>
      </el-table-column>
    </el-table>

    <!-- 分页器 -->
    <div class="pagination-container">
      <el-pagination v-model:current-page="currentPage" v-model:page-size="pageSize" :page-sizes="[20, 50, 100, 200]"
        background layout="total, sizes, prev, pager, next, jumper" :total="total" @size-change="handleSizeChange"
        @current-change="handleCurrentChange" />
    </div>

    <!-- 弹窗部分 -->
    <el-dialog v-model="dialogVisible" :title="form.id ? '编辑词根' : '新增词根'" width="550px" @closed="resetForm">
      <el-form :model="form" label-width="100px" ref="formRef" :rules="rules" label-position="left">
        <el-form-item label="中文名称" prop="cn_name">
          <el-input v-model="form.cn_name" placeholder="如：金额" />
        </el-form-item>
        <el-form-item label="英文全称" prop="en_full_name">
          <el-input v-model="form.en_full_name" placeholder="如：Amount" />
        </el-form-item>
        <el-form-item label="英文缩写" prop="en_abbr">
          <el-input v-model="form.en_abbr" placeholder="如：amt" />
        </el-form-item>
        <el-form-item label="同义词" prop="associated_terms">
          <el-input v-model="form.associated_terms" placeholder="多个同义词请用【空格】隔开，如：金额 钱 费用" />
        </el-form-item>
        <el-form-item label="备注">
          <el-input v-model="form.remark" type="textarea" :rows="3" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="dialogVisible = false">取消</el-button>
        <el-button type="primary" @click="saveRoot" :loading="submitting">确定</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { Plus, Search, Download, Upload, Delete } from '@element-plus/icons-vue';
import { dictionaryApi } from '../api';
import type { WordRoot } from '../types';
import { ElMessageBox, ElMessage, ElLoading } from 'element-plus';
import * as XLSX from 'xlsx';
import { logger } from '../utils/logger';

// --- 状态变量 ---
const loading = ref(false);
const submitting = ref(false);
const roots = ref<WordRoot[]>([]);
const searchQuery = ref('');
const dialogVisible = ref(false);
const formRef = ref();

// 分页相关
const currentPage = ref(1);
const pageSize = ref(20);
const total = ref(0);

const form = ref<WordRoot>({
  cn_name: '',
  en_abbr: '',
  en_full_name: '',
  associated_terms: '',
  remark: ''
});

const rules = {
  cn_name: [{ required: true, message: '请输入中文名称', trigger: 'blur' }],
  en_abbr: [{ required: true, message: '请输入英文缩写', trigger: 'blur' }],
};

// --- 核心加载逻辑 ---
const fetchRoots = async () => {
  logger.info("Root:UI", "请求加载词根分页列表", { page: currentPage.value, size: pageSize.value, q: searchQuery.value });
  loading.value = true;
  try {
    const { data } = await dictionaryApi.getRoots(currentPage.value, pageSize.value, searchQuery.value);
    roots.value = data.items;
    total.value = data.total;
    logger.debug("Root:Data", "词根数据同步完成", { count: data.items.length, total: data.total });
  } catch (error) {
    // 拦截器已处理日志
  } finally {
    loading.value = false;
  }
};

const handleCurrentChange = (val: number) => {
  currentPage.value = val;
  fetchRoots();
};

const handleSizeChange = (val: number) => {
  pageSize.value = val;
  currentPage.value = 1;
  fetchRoots();
};

let timer: any = null;
const handleSearch = () => {
  if (timer) clearTimeout(timer);
  timer = setTimeout(() => {
    logger.info("Root:UI", "触发服务端搜索", searchQuery.value);
    currentPage.value = 1;
    fetchRoots();
  }, 400);
};

// --- 危险操作：一键清空 ---
const handleClearAll = () => {
  ElMessageBox.confirm(
    '此操作将永久清空数据库和向量库中的【所有】词根！建议操作前先执行导出备份。',
    '高危清理指令',
    { confirmButtonText: '确认清空', cancelButtonText: '取消', type: 'error', confirmButtonClass: 'el-button--danger' }
  ).then(async () => {
    logger.warn("Root:Action", "管理员执行全量清空指令");
    const loadingInstance = ElLoading.service({ text: '正在清理全局索引...' });
    try {
      const res = await dictionaryApi.clearAllRoots();
      logger.info("Root:Action", "清空任务成功完成", res.data);
      ElMessage.success(res.data);
      currentPage.value = 1;
      await fetchRoots();
    } catch (error) {
      // 错误已拦截
    } finally {
      loadingInstance.close();
    }
  }).catch(() => { logger.debug("Root:UI", "用户取消了清空操作"); });
};

// --- 导出逻辑 ---
const handleExport = async () => {
  logger.info("Root:Action", "开始全量导出词根数据");
  const loadingInstance = ElLoading.service({ text: '正在扫描全表数据并生成文件...' });
  try {
    const { data } = await dictionaryApi.getRoots(1, 10000, searchQuery.value);
    
    const exportData = data.items.map((r, index) => ({
      "序号": index + 1,
      "中文名称": r.cn_name,
      "英文全称": r.en_full_name || '',
      "英文缩写": r.en_abbr,
      "同义词": r.associated_terms || '',
      "备注": r.remark || ''
    }));

    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "标准词根库");
    XLSX.writeFile(wb, `词根导出_${new Date().getTime()}.xlsx`);
    logger.info("Root:Action", "Excel 导出成功");
    ElMessage.success("全量导出成功");
  } catch (e) {
    logger.error("Root:Action", "导出任务崩溃", e);
  } finally {
    loadingInstance.close();
  }
};

// --- 导入逻辑 ---
const handleImport = (file: any) => {
  logger.info("Root:Action", "准备导入 Excel 文件", file.name);
  const reader = new FileReader();
  reader.onload = async (e: any) => {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const wsName = workbook.SheetNames[0];
      if (!wsName) return;
      const worksheet = workbook.Sheets[wsName];
      if (!worksheet) return;

      const json: any[] = XLSX.utils.sheet_to_json(worksheet);
      logger.debug("Root:Data", "Excel 解析原始行数", json.length);

      const formattedData = json.map((item: any) => ({
        cn_name: String(item["中文名称"] || "").trim(),
        en_full_name: String(item["英文全称"] || "").trim(),
        en_abbr: String(item["英文缩写"] || "").trim(),
        associated_terms: String(item["同义词"] || "").trim(),
        remark: String(item["备注"] || "").trim()
      })).filter(item => item.cn_name && item.en_abbr);

      logger.info("Root:Action", "数据格式化完成，准备推送后端", { validRows: formattedData.length });

      if (formattedData.length === 0) {
        ElMessage.error("未找到有效数据");
        return;
      }

      const loadingInstance = ElLoading.service({ text: '同步数据并构建向量索引中...' });
      try {
        const res = await dictionaryApi.batchCreateRoots(formattedData);
        const result = res.data;
        logger.info("Root:Service", "批量导入接口结果回执", result);

        if (result.failure_count > 0) {
          ElMessageBox.confirm(
            `导入报告：成功 ${result.success_count}，失败 ${result.failure_count}。是否下载失败原因列表？`,
            '批量导入结果',
            { confirmButtonText: '查看详情', cancelButtonText: '关闭', type: 'warning' }
          ).then(() => {
            ElMessageBox.alert(
              `<div style="max-height:300px;overflow:auto;color:#f56c6c">${result.errors.join('<br/>')}</div>`,
              '失败原因清单',
              { dangerouslyUseHTMLString: true }
            );
          });
        } else {
          ElMessage.success(`导入成功，共 ${result.success_count} 条`);
        }
        currentPage.value = 1;
        await fetchRoots();
      } catch (err: any) {
        logger.error("Root:Service", "批量导入网络异常", err);
      } finally {
        loadingInstance.close();
      }
    } catch (err) {
      logger.error("Root:Action", "本地文件解析异常", err);
    }
  };
  reader.readAsArrayBuffer(file.raw);
};

// --- CRUD 操作 ---
const openAddDialog = () => { 
  logger.debug("Root:UI", "打开新增词根对话框");
  form.value = { cn_name: '', en_abbr: '', en_full_name: '', associated_terms: '', remark: '' };
  dialogVisible.value = true; 
};

const handleEdit = (row: WordRoot) => {
  logger.debug("Root:UI", "进入编辑模式", { id: row.id });
  form.value = { ...row };
  dialogVisible.value = true;
};

const handleDelete = async (id: number) => {
  logger.warn("Root:Action", `执行删除操作，ID: ${id}`);
  try {
    await dictionaryApi.deleteRoot(id);
    ElMessage.success('已删除');
    await fetchRoots();
  } catch (e) { /* 处理已由拦截器记录 */ }
};

const saveRoot = async () => {
  if (!formRef.value) return;
  await formRef.value.validate(async (valid: boolean) => {
    if (valid) {
      const isEdit = !!form.value.id;
      logger.info("Root:Action", isEdit ? "提交更新请求" : "提交新增请求", form.value);
      submitting.value = true;
      try {
        if (isEdit) {
          await dictionaryApi.updateRoot(form.value.id!, form.value);
        } else {
          await dictionaryApi.createRoot(form.value);
        }
        ElMessage.success('保存成功');
        dialogVisible.value = false;
        await fetchRoots();
      } finally {
        submitting.value = false;
      }
    }
  });
};

const resetForm = () => {
  logger.debug("Root:UI", "重置词根表单数据");
  form.value = { cn_name: '', en_abbr: '', en_full_name: '', associated_terms: '', remark: '' };
};

onMounted(fetchRoots);
</script>

<style scoped>
.toolbar { display: flex; justify-content: space-between; margin-bottom: 20px; }
.en-code { background: #f0f7ff; color: #409eff; padding: 3px 6px; border-radius: 4px; font-family: 'Consolas', monospace; font-weight: bold; }
.root-container { padding: 10px; }
.pagination-container { margin-top: 20px; display: flex; justify-content: flex-end; }
:deep(.el-upload) { display: inline-block; }
.right .el-button { margin-left: 8px; }
</style>
</file>

<file path="src/views/UserSearch.vue">
<template>
  <div class="user-search-container">
    <div class="search-header">
      <h1>数据标准查询门户</h1>
      <p>输入业务术语，获取研发标准命名</p>
    </div>

    <div class="search-main">
      <el-input 
        v-model="queryText" 
        placeholder="输入中文名称 (如: 支付金额)" 
        size="large" 
        clearable
        @keyup.enter="doSearch"
      >
        <template #append>
          <el-button :icon="Search" @click="doSearch">搜索标准</el-button>
        </template>
      </el-input>

      <div class="result-list" v-loading="loading">
        <!-- 情况 A: 找到了结果 (无论是精准匹配还是语义推荐) -->
        <template v-if="results.length > 0">
          <div class="section-tag">
            <el-icon><CircleCheck /></el-icon> 匹配到以下相关标准：
          </div>
          
          <el-card v-for="item in results" :key="item.id" class="result-item" shadow="hover">
            <div class="item-content">
              <div class="info">
                <div class="cn-row">
                  <span class="cn-name">{{ item.field_cn_name }}</span>
                  <!-- 只有通过向量搜索出来的推荐结果才显示匹配度 -->
                  <el-tag v-if="item.score" size="small" type="warning" effect="light" class="score-tag">
                    推荐匹配 {{ (item.score * 100).toFixed(0) }}%
                  </el-tag>
                  <el-tag v-else size="small" type="success" effect="plain" class="score-tag">
                    精准匹配
                  </el-tag>
                </div>
                <div class="en-name">{{ item.field_en_name }}</div>
              </div>
              <div class="meta">
                <el-tag size="small" info>{{ item.data_type }}</el-tag>
              </div>
            </div>
          </el-card>

          <!-- 核心改进：即使有结果，也允许用户发起“这不是我想要的”申请 -->
          <div class="not-found-footer">
            <span>没找到想要的精准标准？</span>
            <el-button type="primary" link @click="requestNew">提交新增申请</el-button>
          </div>
        </template>

        <!-- 情况 B: 搜索过但完全没有任何结果 -->
        <el-empty v-else-if="hasSearched && results.length === 0" description="未找到相关标准定义">
          <template #default>
            <p class="empty-tip">该字段可能尚未录入标准库，您可以向管理员发起申请</p>
            <el-button type="primary" @click="requestNew">立即申请新增标准</el-button>
          </template>
        </el-empty>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';
import { Search, CircleCheck } from '@element-plus/icons-vue';
import { dictionaryApi } from '../api';
import { ElMessage } from 'element-plus';
import { logger } from '../utils/logger';

const queryText = ref('');
const loading = ref(false);
const results = ref<any[]>([]);
const hasSearched = ref(false);

const doSearch = async () => {
  const q = queryText.value.trim();
  if (!q) return;

  logger.info("SearchPortal", "执行标准查询", q);
  loading.value = true;
  results.value = [];

  try {
    const { data } = await dictionaryApi.searchField(q);
    results.value = data;
    hasSearched.value = true;
    logger.debug("SearchPortal", `查询结束，召回 ${data.length} 条结果`);
  } catch (e) {
    logger.error("SearchPortal", "搜索接口异常", e);
  } finally {
    loading.value = false;
  }
};

const requestNew = async () => {
  const q = queryText.value.trim();
  if (!q) {
    ElMessage.warning("请先在搜索框输入您想申请的字段名称");
    return;
  }

  try {
    logger.info("SearchPortal", "提交新增申请", q);
    await dictionaryApi.submitRequest(q);
    ElMessage({
      message: `申请已提交: 【${q}】，管理员处理后将通知您`,
      type: 'success',
      duration: 5000
    });
  } catch (e) {
    logger.error("SearchPortal", "提交申请失败", e);
  }
};
</script>

<style scoped>
.user-search-container {
  max-width: 800px;
  margin: 60px auto;
  padding: 0 20px;
}

.search-header {
  text-align: center;
  margin-bottom: 40px;
}

.search-header h1 {
  font-size: 28px;
  color: #303133;
}

.search-header p {
  color: #909399;
  margin-top: 10px;
}

.result-list {
  margin-top: 40px;
}

.result-item {
  margin-bottom: 16px;
  border-radius: 8px;
  transition: all 0.3s;
}

.result-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.item-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.cn-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 6px;
}

.cn-name {
  font-size: 18px;
  font-weight: bold;
  color: #303133;
}

.en-name {
  font-family: 'Consolas', 'Monaco', monospace;
  color: #409eff;
  font-size: 15px;
  font-weight: 600;
}

.score-tag {
  font-weight: normal;
}

.section-tag {
  font-size: 14px;
  color: #606266;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.not-found-footer {
  margin-top: 30px;
  padding: 20px;
  text-align: center;
  border-top: 1px dashed #dcdfe6;
  color: #909399;
  font-size: 14px;
}

.empty-tip {
  color: #909399;
  margin-bottom: 20px;
}
</style>
</file>

<file path="src/views/StandardFieldList.vue">
<template>
  <div class="field-container">
    <!-- 顶部操作栏 -->
    <div class="toolbar">
      <div class="left">
        <el-input v-model="searchQuery" placeholder="搜索标准名或同义词..." style="width: 320px;" :prefix-icon="Search" clearable
          @input="handleSearch" />
      </div>
      <div class="right">
        <el-button type="success" :icon="Download" @click="handleExport" :disabled="fields.length === 0">
          导出备份
        </el-button>
        <el-button type="danger" plain :icon="Delete" @click="handleClearAll">
          清空所有
        </el-button>
        <el-divider direction="vertical" />
        <el-button type="primary" :icon="Plus" @click="openAddDialog">
          新增标准字段
        </el-button>
      </div>
    </div>

    <!-- 数据表格 -->
    <el-table :data="fields" border v-loading="loading" row-key="id" style="width: 100%">
      <el-table-column prop="id" label="ID" width="70" align="center" />
      <el-table-column prop="field_cn_name" label="标准中文名" width="180" />
      <el-table-column prop="field_en_name" label="英文标准名" width="220">
        <template #default="{ row }">
          <code class="en-code">{{ row.field_en_name }}</code>
        </template>
      </el-table-column>
      <el-table-column prop="associated_terms" label="同义词/关联词" show-overflow-tooltip />
      <el-table-column prop="data_type" label="数据类型" width="130" />
      <el-table-column prop="created_at" label="发布时间" width="180">
        <template #default="{ row }">
          {{ row.created_at ? new Date(row.created_at).toLocaleString() : '-' }}
        </template>
      </el-table-column>
      <el-table-column label="操作" width="200" fixed="right" align="center">
        <template #default="{ row }">
          <el-button link type="primary" @click="handleEdit(row)">编辑</el-button>
          <el-button link type="info" @click="showDetail(row)">组成详情</el-button>
          <el-popconfirm title="确定删除该标准字段吗？" @confirm="handleDelete(row.id)">
            <template #reference>
              <el-button link type="danger">删除</el-button>
            </template>
          </el-popconfirm>
        </template>
      </el-table-column>
    </el-table>

    <!-- 分页器 -->
    <div class="pagination-container">
      <el-pagination
        v-model:current-page="currentPage"
        v-model:page-size="pageSize"
        :page-sizes="[20, 50, 100]"
        background
        layout="total, sizes, prev, pager, next, jumper"
        :total="total"
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
      />
    </div>

    <!-- 新增/编辑弹窗 -->
    <el-dialog v-model="dialogVisible" :title="form.id ? '修改标准字段' : '新增标准字段'" width="850px" @closed="resetForm">
      <el-form :model="form" label-width="110px" ref="formRef" :rules="rules">
        <el-form-item label="标准中文名" prop="field_cn_name">
          <el-input v-model="form.field_cn_name" placeholder="如：客户支付状态" @input="handleAnalyze" clearable />
        </el-form-item>

        <div class="analysis-box">
          <div class="box-title">词根选择与校验矩阵：</div>

          <div v-if="analysisSegments.length > 0" class="segment-matrix">
            <div v-for="(seg, idx) in analysisSegments" :key="idx" class="matrix-column" 
                 :class="{ 'is-missing': seg.candidates.length === 0 }">
              <div class="seg-label">{{ seg.word }}</div>
              
              <div v-if="seg.candidates.length > 0" class="cand-list">
                <el-check-tag
                  v-for="cand in seg.candidates"
                  :key="cand.id"
                  :checked="selectedRootIds[idx] === cand.id"
                  @change="selectRoot(idx, cand)"
                  class="cand-item"
                >
                  <div class="cand-main">
                    {{ cand.en_abbr }} <span class="cand-cn">({{ cand.cn_name }})</span>
                  </div>
                  <div v-if="!cand.cn_name.includes(seg.word)" class="hit-reason">
                    命中: {{ cand.associated_terms }}
                  </div>
                </el-check-tag>
              </div>

              <div v-else class="missing-status">
                <div class="error-text">未找到词根</div>
                <el-button type="primary" link :icon="Search" @click="searchSimilar(seg.word)">找词</el-button>
              </div>
            </div>
          </div>
          <div v-else class="status-empty">等待输入中文名进行智能解析...</div>

          <div class="en-preview-bar" v-if="analysisSegments.length > 0">
            <div class="p-label">预测标准英文名：</div>
            <div class="p-value">
              <template v-for="(part, i) in previewParts" :key="i">
                <span :class="{ 'unselected': part === '??' }">{{ part }}</span>
                <i v-if="i < previewParts.length - 1">_</i>
              </template>
            </div>
          </div>
        </div>

        <el-form-item label="关联同义词" prop="associated_terms">
          <el-input v-model="form.associated_terms" placeholder="多个同义词用空格隔开，方便用户搜索" />
        </el-form-item>

        <el-form-item label="数据类型" prop="data_type">
          <el-select v-model="form.data_type" placeholder="选择字段数据类型" style="width: 100%">
            <el-option label="VARCHAR(50)" value="VARCHAR(50)" />
            <el-option label="VARCHAR(100)" value="VARCHAR(100)" />
            <el-option label="INT" value="INT" />
            <el-option label="DECIMAL(18,2)" value="DECIMAL(18,2)" />
            <el-option label="TIMESTAMP" value="TIMESTAMP" />
          </el-select>
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="dialogVisible = false">取消</el-button>
        <el-button type="primary" @click="submitForm" :loading="submitting"
          :disabled="!isSelectionComplete">
          确认正式入库
        </el-button>
      </template>
    </el-dialog>

    <!-- 语义相似搜索弹窗 -->
    <el-dialog v-model="similarDialogVisible" :title="`针对【${searchingWord}】的推荐词根`" width="450px">
      <el-table :data="similarRoots" size="small" border>
        <el-table-column prop="cn_name" label="已有词根" />
        <el-table-column prop="en_abbr" label="缩写" />
        <el-table-column label="相似度" width="100">
          <template #default="{ row }">
            {{ (row.score * 100).toFixed(1) }}%
          </template>
        </el-table-column>
      </el-table>
    </el-dialog>

    <!-- 组成详情抽屉 -->
    <el-drawer v-model="drawerVisible" title="标准字段组成解析" size="400px">
      <div v-if="selectedField" class="detail-content">
        <el-descriptions :column="1" border>
          <el-descriptions-item label="标准中文名">{{ selectedField.field_cn_name }}</el-descriptions-item>
          <el-descriptions-item label="标准英文名">{{ selectedField.field_en_name }}</el-descriptions-item>
        </el-descriptions>
        <h4 style="margin-top: 25px">原子词根链</h4>
        <el-timeline style="margin-top: 15px">
          <el-timeline-item v-for="root in detailRoots" :key="root.id" :timestamp="root.en_abbr" placement="top" type="primary">
            <el-card shadow="never">
              <div style="font-weight: bold">{{ root.cn_name }}</div>
              <div style="font-size: 12px; color: #999; margin-top: 5px">ID: {{ root.id }} | {{ root.remark || '无备注' }}</div>
            </el-card>
          </el-timeline-item>
        </el-timeline>
      </div>
    </el-drawer>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, computed, reactive } from 'vue';
import { Delete, Plus, Search, Download } from '@element-plus/icons-vue';
import { dictionaryApi } from '../api';
import type { StandardField, WordRoot, Segment } from '../types';
import { ElMessageBox, ElMessage, ElLoading } from 'element-plus';
import * as XLSX from 'xlsx';
import { logger } from '../utils/logger';

const formRef = ref();
const loading = ref(false);
const submitting = ref(false);
const fields = ref<StandardField[]>([]);
const searchQuery = ref('');
const dialogVisible = ref(false);
const drawerVisible = ref(false);

const currentPage = ref(1);
const pageSize = ref(20);
const total = ref(0);

const similarDialogVisible = ref(false);
const similarRoots = ref<any[]>([]);
const searchingWord = ref('');

const analysisSegments = ref<Segment[]>([]); 
const selectedRootIds = reactive<Record<number, number>>({}); 
const selectedRoots = reactive<Record<number, WordRoot>>({});    

const selectedField = ref<StandardField | null>(null);
const detailRoots = ref<WordRoot[]>([]);

const form = ref<any>({
  id: undefined,
  field_cn_name: '',
  field_en_name: '',
  associated_terms: '',
  data_type: 'VARCHAR(100)',
  composition_ids: []
});

const rules = {
  field_cn_name: [{ required: true, message: '请输入中文全称', trigger: 'blur' }],
  data_type: [{ required: true, message: '请选择数据类型', trigger: 'change' }]
};

const fetchFields = async () => {
  logger.info("Field:UI", "加载字段列表", { page: currentPage.value, q: searchQuery.value });
  loading.value = true;
  try {
    const { data } = await dictionaryApi.getFields(currentPage.value, pageSize.value, searchQuery.value);
    fields.value = data.items;
    total.value = data.total;
  } finally { loading.value = false; }
};

const handleCurrentChange = (val: number) => {
  currentPage.value = val;
  fetchFields();
};

const handleSizeChange = (val: number) => {
  pageSize.value = val;
  currentPage.value = 1;
  fetchFields();
};

let searchTimer: any = null;
const handleSearch = () => {
  if (searchTimer) clearTimeout(searchTimer);
  searchTimer = setTimeout(() => {
    currentPage.value = 1;
    fetchFields();
  }, 400);
};

let analyzeTimer: any = null;
const handleAnalyze = () => {
  if (analyzeTimer) clearTimeout(analyzeTimer);
  analyzeTimer = setTimeout(async () => {
    const input = form.value.field_cn_name?.trim();
    if (!input) {
      analysisSegments.value = [];
      return;
    }
    try {
      const { data } = await dictionaryApi.getSuggest(input);
      analysisSegments.value = data.segments;
      
      const existingIds = [...form.value.composition_ids];
      
      Object.keys(selectedRootIds).forEach(key => delete selectedRootIds[Number(key)]);
      Object.keys(selectedRoots).forEach(key => delete selectedRoots[Number(key)]);

      data.segments.forEach((seg, index) => {
        const savedId = existingIds[index];
        // 核心修复：增加 null/undefined 检查
        const savedMatch = seg.candidates.find(c => c.id === savedId);
        const firstCandidate = seg.candidates[0];

        if (savedMatch) {
            selectRoot(index, savedMatch);
        } else if (seg.candidates.length === 1 && firstCandidate) {
            selectRoot(index, firstCandidate);
        }
      });
    } catch (e) { logger.error("Analyzer", "解析请求失败", e); }
  }, 400);
};

const selectRoot = (index: number, root: WordRoot) => {
  if (root && root.id) {
    selectedRootIds[index] = root.id;
    selectedRoots[index] = root;
    syncToForm();
  }
};

const syncToForm = () => {
  form.value.field_en_name = previewParts.value.join('_');
  form.value.composition_ids = analysisSegments.value
    .map((_, i) => selectedRootIds[i])
    .filter(id => !!id);
};

const previewParts = computed(() => {
  return analysisSegments.value.map((_, i) => selectedRoots[i]?.en_abbr || '??');
});

const isSelectionComplete = computed(() => {
  if (analysisSegments.value.length === 0) return false;
  return analysisSegments.value.every((_, i) => !!selectedRootIds[i]);
});

const searchSimilar = async (word: string) => {
  searchingWord.value = word;
  try {
    const { data } = await dictionaryApi.getSimilarRoots(word);
    similarRoots.value = data;
    similarDialogVisible.value = true;
  } catch (e) { ElMessage.error("检索失败"); }
};

const handleExport = async () => {
  const loadingInstance = ElLoading.service({ text: '准备导出数据...' });
  try {
    const { data } = await dictionaryApi.getFields(1, 10000, searchQuery.value);
    const exportData = data.items.map((f, index) => ({
      "序号": index + 1,
      "标准中文名": f.field_cn_name,
      "标准英文名": f.field_en_name,
      "数据类型": f.data_type,
      "关联同义词": f.associated_terms || '-',
      "发布时间": f.created_at ? new Date(f.created_at).toLocaleString() : '-'
    }));
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "数据标准清单");
    XLSX.writeFile(wb, `标准字段导出_${new Date().getTime()}.xlsx`);
  } finally { loadingInstance.close(); }
};

const submitForm = async () => {
  if (!formRef.value) return;
  await formRef.value.validate(async (valid: boolean) => {
    if (valid) {
      const isEdit = !!form.value.id;
      logger.info("Field:Action", isEdit ? "更新字段" : "创建字段", form.value);
      submitting.value = true;
      try {
        if (isEdit) {
          await dictionaryApi.updateField(form.value.id, form.value);
        } else {
          await dictionaryApi.createField(form.value);
        }
        ElMessage.success('保存成功');
        dialogVisible.value = false;
        fetchFields();
      } finally { submitting.value = false; }
    }
  });
};

const handleDelete = async (id: number) => {
  try {
    await dictionaryApi.deleteField(id);
    ElMessage.success('已删除');
    fetchFields();
  } catch (e) {}
};

const showDetail = async (row: StandardField) => {
  selectedField.value = row;
  detailRoots.value = [];
  drawerVisible.value = true;
  try {
    const { data } = await dictionaryApi.getFieldDetails(row.id!);
    detailRoots.value = data;
  } catch (e) { ElMessage.error("详情加载失败"); }
};

const openAddDialog = () => { resetForm(); dialogVisible.value = true; };
const handleEdit = (row: StandardField) => {
  form.value = { ...row };
  handleAnalyze();
  dialogVisible.value = true;
};
const resetForm = () => {
  form.value = { id: undefined, field_cn_name: '', field_en_name: '', associated_terms: '', data_type: 'VARCHAR(100)', composition_ids: [] };
  analysisSegments.value = [];
  Object.keys(selectedRootIds).forEach(key => delete selectedRootIds[Number(key)]);
  Object.keys(selectedRoots).forEach(key => delete selectedRoots[Number(key)]);
};

const handleClearAll = () => {
  ElMessageBox.confirm('警告：此操作将永久清空标准库和向量索引！', '高危操作', { 
    confirmButtonText: '确定清空', cancelButtonText: '取消', type: 'error' 
  }).then(async () => {
    const loadingInstance = ElLoading.service({ text: '清理中...' });
    try {
      const res = await dictionaryApi.clearAllFields();
      ElMessage.success(res.data);
      await fetchFields();
    } finally { loadingInstance.close(); }
  }).catch(() => {});
};

onMounted(fetchFields);
</script>

<style scoped>
.en-code { background: #f0f7ff; color: #409eff; padding: 3px 8px; border-radius: 4px; font-family: monospace; font-weight: bold; }
.analysis-box { background: #f8f9fa; padding: 18px; border-radius: 8px; margin-bottom: 25px; border: 1px dashed #dcdfe6; }
.box-title { font-size: 13px; color: #606266; margin-bottom: 15px; font-weight: bold; }
.segment-matrix { display: flex; flex-wrap: wrap; gap: 15px; }
.matrix-column { background: #fff; border: 1px solid #e4e7ed; border-radius: 6px; padding: 12px; min-width: 160px; flex: 1; }
.matrix-column.is-missing { border-color: #f56c6c; background: #fff8f8; }
.seg-label { font-size: 12px; color: #909399; margin-bottom: 10px; text-align: center; border-bottom: 1px solid #f2f6fc; padding-bottom: 6px; font-weight: bold;}
.cand-list { display: flex; flex-direction: column; gap: 6px; }
.cand-item { width: 100%; text-align: left; cursor: pointer; height: auto; padding: 6px 10px; border: 1px solid #eee; }
.cand-main { font-weight: bold; font-size: 14px; }
.cand-cn { font-size: 11px; opacity: 0.6; font-weight: normal; }
.hit-reason { font-size: 10px; color: #999; margin-top: 4px; font-style: italic; }
.missing-status { text-align: center; padding: 10px 0; }
.error-text { font-size: 12px; color: #f56c6c; margin-bottom: 5px; }
.en-preview-bar { margin-top: 20px; padding: 15px; background: #f0f9eb; border-radius: 6px; display: flex; align-items: center; border: 1px solid #e1f3d8; }
.preview-label { font-size: 13px; color: #67c23a; margin-right: 12px; font-weight: bold;}
.preview-value { font-family: monospace; font-size: 18px; color: #303133; }
.unselected { color: #f56c6c; text-decoration: underline; }
.status-empty { color: #c0c4cc; text-align: center; font-size: 13px; padding: 20px 0;}
.pagination-container { margin-top: 20px; display: flex; justify-content: flex-end; }
.toolbar { display: flex; justify-content: space-between; margin-bottom: 20px; }
.field-container { padding: 10px; }
.right .el-button { margin-left: 8px; }
</style>
</file>

<file path="src/api/index.ts">
import axios from 'axios';
import router from '../router';
import type { WordRoot, SuggestResponse, StandardField, AuthPayload, AuthResponse } from '../types';
import { ElMessage } from 'element-plus';
import { logger } from '../utils/logger';

const request = axios.create({
  baseURL: '/api', // Vite 代理会将 /api 转发到 http://127.0.0.1:3000
  timeout: 600000
});

// 请求拦截器：每秒检查一次本地存储，如果有 Token 则注入 Header
request.interceptors.request.use((config) => {
  const token = localStorage.getItem('token');
  if (token && config.headers) {
    config.headers.Authorization = `Bearer ${token}`;
  }

  logger.debug("Network", `>>> 发起请求 [${config.method?.toUpperCase()}] ${config.url}`, config.params || config.data);

  return config;
});

// 响应拦截器：统一处理 401/403 错误
request.interceptors.response.use(
  (res) => {
    logger.debug("Network", `<<< 收到响应 [${res.status}] ${res.config.url}`, res.data);
    return res;
  },
  (err) => {

    const status = err.response?.status;
    const url = err.config?.url;

    logger.error("Network", `!!! 请求异常 [${status || 'TIMEOUT'}] ${url}`, {
      message: err.message,
      data: err.response?.data
    });

    if (err.response) {
      if (err.response.status === 401 || err.response.status === 403) {
        // 只要是权限报错，不管是过期还是越权，一律视作“当前会话失效”
        // 立即清除所有本地缓存并跳回登录，方便用户换号登录
        localStorage.clear();
        router.push('/login');
        ElMessage.error('权限验证失败，请使用管理员账号重新登录');
      } else {
        ElMessage.error(err.response.data || '系统错误');
      }
    }
    return Promise.reject(err);
  }
);

export const dictionaryApi = {
  // --- 身份认证 (对应后端 .nest("/api/auth", ...)) ---
  login: (data: AuthPayload) => request.post<AuthResponse>('/auth/login', data),
  signup: (data: AuthPayload) => request.post('/auth/signup', data),

  // --- 公共查询 (对应后端 .nest("/api/public", ...)) ---
  searchField: (q: string) =>
    request.get<StandardField[]>(`/public/search?q=${encodeURIComponent(q)}`),

  // --- 管理端接口 (对应后端 .nest("/api/admin", ...)) ---
  // 词根管理
  getRoots: (page: number, pageSize: number, q?: string) =>
    request.get<PaginatedResponse<WordRoot>>(`/admin/roots?page=${page}&page_size=${pageSize}&q=${encodeURIComponent(q || '')}`),
  createRoot: (data: WordRoot) => request.post('/admin/roots', data),
  updateRoot: (id: number, data: WordRoot) => request.put(`/admin/roots/${id}`, data),
  deleteRoot: (id: number) => request.delete(`/admin/roots/${id}`),

  // 智能建议
  getSuggest: (q: string) =>
    request.get<SuggestResponse>(`/admin/suggest?q=${encodeURIComponent(q)}`),

  // 标准字段管理
  getFields: (page: number, pageSize: number, q?: string) =>
    request.get<PaginatedResponse<StandardField>>(`/admin/fields?page=${page}&page_size=${pageSize}&q=${encodeURIComponent(q || '')}`),
  createField: (data: any) => request.post('/admin/fields', data),
  updateField: (id: number, data: any) => request.put(`/admin/fields/${id}`, data),
  deleteField: (id: number) => request.delete(`/admin/fields/${id}`),
  getFieldDetails: (id: number) => request.get<WordRoot[]>(`/admin/fields/${id}`),

  // 用户管理接口
  getUsers: () => request.get<any[]>('/admin/users'),
  updateUserRole: (id: number, role: string) => request.put(`/admin/users/${id}`, { role }),
  deleteUser: (id: number) => request.delete(`/admin/users/${id}`),

  // 管理员创建用户
  adminCreateUser: (data: any) => request.post('/admin/users', data),

  getSimilarRoots: (q: string) =>
    request.get<any[]>(`/public/similar-roots?q=${encodeURIComponent(q)}`),

  // 添加批量接口
  batchCreateRoots: (items: WordRoot[]) => request.post('/admin/roots/batch', { items }),

  clearAllRoots: () => request.delete('/admin/roots/clear'),

  clearAllFields: () => request.delete('/admin/fields/clear'),

  submitRequest: (cnName: string) => request.post('/public/tasks', { field_cn_name: cnName }),

  getTasks: () => request.get<any[]>('/admin/tasks'),
  completeTask: (id: number) => request.put(`/admin/tasks/${id}`),
  getTaskCount: () => request.get<{ count: number }>('/admin/tasks/count'),
};

export interface PaginatedResponse<T> {
  items: T[];
  total: number;
}
</file>

</files>
