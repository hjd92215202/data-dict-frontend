This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
index.html
package.json
public/vite.svg
README.md
src/api/index.ts
src/App.vue
src/assets/vue.svg
src/components/SmartMapper.vue
src/layouts/AdminLayout.vue
src/main.ts
src/router/index.ts
src/style.css
src/types/index.ts
src/views/Login.vue
src/views/Signup.vue
src/views/StandardFieldList.vue
src/views/UserManagement.vue
src/views/UserSearch.vue
src/views/WordRootList.vue
tsconfig.app.json
tsconfig.json
tsconfig.node.json
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="index.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>data-dict-frontend</title>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
</file>

<file path="public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="src/assets/vue.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="37.07" height="36" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 198"><path fill="#41B883" d="M204.8 0H256L128 220.8L0 0h97.92L128 51.2L157.44 0h47.36Z"></path><path fill="#41B883" d="m0 0l128 220.8L256 0h-51.2L128 132.48L50.56 0H0Z"></path><path fill="#35495E" d="M50.56 0L128 133.12L204.8 0h-47.36L128 51.2L97.92 0H50.56Z"></path></svg>
</file>

<file path="src/style.css">
:root {
  font-family: system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-weight: 400;

  color-scheme: light dark;
  color: rgba(255, 255, 255, 0.87);
  background-color: #242424;

  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

a {
  font-weight: 500;
  color: #646cff;
  text-decoration: inherit;
}
a:hover {
  color: #535bf2;
}

body {
  margin: 0;
  display: flex;
  place-items: center;
  min-width: 320px;
  min-height: 100vh;
}

h1 {
  font-size: 3.2em;
  line-height: 1.1;
}

button {
  border-radius: 8px;
  border: 1px solid transparent;
  padding: 0.6em 1.2em;
  font-size: 1em;
  font-weight: 500;
  font-family: inherit;
  background-color: #1a1a1a;
  cursor: pointer;
  transition: border-color 0.25s;
}
button:hover {
  border-color: #646cff;
}
button:focus,
button:focus-visible {
  outline: 4px auto -webkit-focus-ring-color;
}

.card {
  padding: 2em;
}

#app {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

@media (prefers-color-scheme: light) {
  :root {
    color: #213547;
    background-color: #ffffff;
  }
  a:hover {
    color: #747bff;
  }
  button {
    background-color: #f9f9f9;
  }
}
</file>

<file path="src/views/Signup.vue">
<template>
  <div class="signup-container">
    <el-card class="signup-card">
      <template #header><h2>æ–°ç®¡ç†å‘˜æ³¨å†Œç”³è¯·</h2></template>
      <el-form :model="form">
        <el-form-item>
          <el-input v-model="form.username" placeholder="è®¾ç½®ç”¨æˆ·å" prefix-icon="User" />
        </el-form-item>
        <el-form-item>
          <el-input v-model="form.password" type="password" placeholder="è®¾ç½®å¯†ç " show-password prefix-icon="Lock" />
        </el-form-item>
        <el-button type="success" @click="handleSignup" :loading="loading" style="width: 100%">
          æäº¤æ³¨å†Œ
        </el-button>
        <div class="link">
          <el-button link @click="$router.push('/login')">å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•</el-button>
        </div>
      </el-form>
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { reactive, ref } from 'vue';
import { dictionaryApi } from '../api';
import { useRouter } from 'vue-router';
import { ElMessage } from 'element-plus';

const router = useRouter();
const loading = ref(false);
const form = reactive({ username: '', password: '' });

const handleSignup = async () => {
  loading.value = true;
  try {
    await dictionaryApi.signup(form);
    ElMessage.success('æ³¨å†ŒæˆåŠŸï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜é€šè¿‡å®¡æ ¸ï¼ˆæˆ–æ‰‹åŠ¨æ”¹DBè§’è‰²ï¼‰');
    router.push('/login');
  } catch (e: any) {
    ElMessage.error(e.response?.data || 'æ³¨å†Œå¤±è´¥');
  } finally {
    loading.value = false;
  }
};
</script>

<style scoped>
.signup-container { height: 100vh; display: flex; justify-content: center; align-items: center; background: #2d3a4b; }
.signup-card { width: 400px; }
.link { text-align: center; margin-top: 15px; }
</style>
</file>

<file path="src/views/UserManagement.vue">
<template>
  <div class="user-management-container">
    <el-card shadow="never" class="main-card">
      <!-- å¤´éƒ¨æ“ä½œåŒº -->
      <template #header>
        <div class="card-header">
          <div class="title-group">
            <span class="title">ç”¨æˆ·æƒé™ç®¡ç†</span>
            <el-tag type="info" size="small" class="ml-2">æ€»è®¡ {{ users.length }} åç”¨æˆ·</el-tag>
          </div>
          <el-button type="primary" :icon="Plus" @click="openAddDialog">
            å¼€é€šæ–°è´¦å·
          </el-button>
        </div>
      </template>

      <!-- ç”¨æˆ·æ•°æ®è¡¨æ ¼ -->
      <el-table :data="users" border v-loading="loading" style="width: 100%">
        <el-table-column prop="id" label="ID" width="80" align="center" />
        <el-table-column prop="username" label="ç™»å½•è´¦å·" min-width="150" />
        
        <el-table-column label="å½“å‰è§’è‰²" width="150" align="center">
          <template #default="{ row }">
            <el-tag :type="row.role === 'admin' ? 'danger' : 'info'" effect="dark">
              {{ row.role === 'admin' ? 'è¶…çº§ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·' }}
            </el-tag>
          </template>
        </el-table-column>

        <el-table-column prop="created_at" label="æ³¨å†Œæ—¶é—´" width="200">
          <template #default="{ row }">
            {{ row.created_at ? new Date(row.created_at).toLocaleString() : '-' }}
          </template>
        </el-table-column>

        <el-table-column label="æƒé™åŠè´¦å·æ“ä½œ" width="280" fixed="right">
          <template #default="{ row }">
            <!-- è§’è‰²åˆ‡æ¢ï¼šä¸èƒ½é™æƒè‡ªå·±ï¼ˆå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒå¢åŠ æ­¤é€»è¾‘ï¼‰ -->
            <el-button 
              v-if="row.role !== 'admin'" 
              link 
              type="warning" 
              @click="handleRoleChange(row, 'admin')"
            >
              è®¾ä¸ºç®¡ç†å‘˜
            </el-button>
            <el-button 
              v-else 
              link 
              type="info" 
              @click="handleRoleChange(row, 'user')"
            >
              é™ä¸ºæ™®é€šç”¨æˆ·
            </el-button>

            <el-divider direction="vertical" />

            <!-- åˆ é™¤æ“ä½œ -->
            <el-popconfirm 
              :title="`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤ç”¨æˆ· [${row.username}] å—ï¼Ÿ`"
              confirm-button-text="ç¡®å®š"
              cancel-button-text="å–æ¶ˆ"
              @confirm="handleDelete(row.id)"
            >
              <template #reference>
                <el-button link type="danger">æ³¨é”€è´¦å·</el-button>
              </template>
            </el-popconfirm>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <!-- æ–°å¢ç”¨æˆ·å¯¹è¯æ¡† -->
    <el-dialog 
      v-model="addDialogVisible" 
      title="å¼€é€šå†…éƒ¨å‘˜å·¥è´¦å·" 
      width="450px"
      @closed="resetAddForm"
      destroy-on-close
    >
      <el-form 
        :model="addForm" 
        ref="addFormRef" 
        :rules="addRules" 
        label-width="80px"
        label-position="top"
      >
        <el-form-item label="ç™»å½•ç”¨æˆ·å" prop="username">
          <el-input v-model="addForm.username" placeholder="å»ºè®®ä½¿ç”¨å§“åæ‹¼éŸ³" />
        </el-form-item>
        
        <el-form-item label="åˆå§‹ç™»å½•å¯†ç " prop="password">
          <el-input 
            v-model="addForm.password" 
            type="password" 
            show-password 
            placeholder="è¯·è®¾ç½®è‡³å°‘6ä½å¯†ç " 
          />
        </el-form-item>

        <el-form-item label="åˆ†é…åˆå§‹è§’è‰²" prop="role">
          <el-radio-group v-model="addForm.role">
            <el-radio label="user" border>æ™®é€šç”¨æˆ· (ä»…æŸ¥è¯¢)</el-radio>
            <el-radio label="admin" border>ç®¡ç†å‘˜ (å¢åˆ æ”¹)</el-radio>
          </el-radio-group>
        </el-form-item>
      </el-form>

      <template #footer>
        <div class="dialog-footer">
          <el-button @click="addDialogVisible = false">å–æ¶ˆ</el-button>
          <el-button type="primary" @click="submitAddUser" :loading="addLoading">
            ç¡®è®¤åˆ›å»º
          </el-button>
        </div>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue';
import { Plus } from '@element-plus/icons-vue';
import { dictionaryApi } from '../api';
import { ElMessage, ElMessageBox } from 'element-plus';

// --- åŸºç¡€çŠ¶æ€ ---
const users = ref<any[]>([]);
const loading = ref(false);

// --- æ–°å¢ç”¨æˆ·ç›¸å…³ ---
const addDialogVisible = ref(false);
const addLoading = ref(false);
const addFormRef = ref();
const addForm = reactive({
  username: '',
  password: '',
  role: 'user'
});

const addRules = {
  username: [
    { required: true, message: 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º', trigger: 'blur' },
    { min: 3, message: 'ç”¨æˆ·åè‡³å°‘3ä½', trigger: 'blur' }
  ],
  password: [
    { required: true, message: 'å¯†ç ä¸èƒ½ä¸ºç©º', trigger: 'blur' },
    { min: 6, message: 'å¯†ç è‡³å°‘6ä½', trigger: 'blur' }
  ],
  role: [
    { required: true, message: 'è¯·é€‰æ‹©è§’è‰²æƒé™', trigger: 'change' }
  ]
};

// --- æ ¸å¿ƒæ–¹æ³• ---

// 1. åŠ è½½ç”¨æˆ·åˆ—è¡¨
const fetchUsers = async () => {
  loading.value = true;
  try {
    const { data } = await dictionaryApi.getUsers();
    users.value = data;
  } catch (error) {
    console.error("åŠ è½½ç”¨æˆ·å¤±è´¥", error);
  } finally {
    loading.value = false;
  }
};

// 2. æ‰“å¼€æ–°å¢å¼¹çª—
const openAddDialog = () => {
  addDialogVisible.value = true;
};

// 3. æäº¤åˆ›å»ºè¯·æ±‚
const submitAddUser = async () => {
  if (!addFormRef.value) return;
  
  await addFormRef.value.validate(async (valid: boolean) => {
    if (valid) {
      addLoading.value = true;
      try {
        await dictionaryApi.adminCreateUser(addForm);
        ElMessage.success(`ç”¨æˆ· ${addForm.username} åˆ›å»ºæˆåŠŸ`);
        addDialogVisible.value = false;
        await fetchUsers(); // åˆ·æ–°åˆ—è¡¨
      } catch (error: any) {
        ElMessage.error(error.response?.data || 'åˆ›å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦é‡å¤');
      } finally {
        addLoading.value = false;
      }
    }
  });
};

// 4. ä¿®æ”¹ç”¨æˆ·è§’è‰²
const handleRoleChange = (row: any, newRole: string) => {
  const roleName = newRole === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·';
  
  ElMessageBox.confirm(
    `ç¡®è®¤å°†ç”¨æˆ· [${row.username}] çš„è§’è‰²ä¿®æ”¹ä¸º [${roleName}] å—ï¼Ÿ`,
    'æƒé™å˜æ›´ç¡®è®¤',
    { type: 'warning' }
  ).then(async () => {
    try {
      await dictionaryApi.updateUserRole(row.id, newRole);
      ElMessage.success('æƒé™æ›´æ–°æˆåŠŸ');
      await fetchUsers();
    } catch (e) {
      ElMessage.error('æƒé™æ›´æ–°å¤±è´¥');
    }
  }).catch(() => {});
};

// 5. åˆ é™¤ç”¨æˆ·
const handleDelete = async (id: number) => {
  try {
    await dictionaryApi.deleteUser(id);
    ElMessage.success('ç”¨æˆ·è´¦å·å·²æ³¨é”€');
    await fetchUsers();
  } catch (e) {
    ElMessage.error('åˆ é™¤æ“ä½œå¤±è´¥');
  }
};

// é‡ç½®è¡¨å•
const resetAddForm = () => {
  addForm.username = '';
  addForm.password = '';
  addForm.role = 'user';
  if (addFormRef.value) addFormRef.value.resetFields();
};

onMounted(fetchUsers);
</script>

<style scoped>
.user-management-container {
  padding: 10px;
}

.main-card {
  border-radius: 8px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.title-group {
  display: flex;
  align-items: center;
}

.title {
  font-size: 16px;
  font-weight: bold;
  color: #303133;
}

.ml-2 {
  margin-left: 8px;
}

.dialog-footer {
  display: flex;
  justify-content: flex-end;
}

/* è®©å•é€‰æ¡†ç»„ç¾è§‚ä¸€ç‚¹ */
:deep(.el-radio.is-bordered) {
  margin-right: 10px;
  margin-bottom: 10px;
}
</style>
</file>

<file path="tsconfig.app.json">
{
  "extends": "@vue/tsconfig/tsconfig.dom.json",
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "types": ["vite/client"],

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src/**/*.ts", "src/**/*.tsx", "src/**/*.vue"]
}
</file>

<file path="tsconfig.json">
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}
</file>

<file path="tsconfig.node.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true,
    
    "allowSyntheticDefaultImports": true,
    "composite": true,
  },
  "include": ["vite.config.ts"]
}
</file>

<file path="vite.config.ts">
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  server: {
    proxy: {
      '/api': {
        target: 'http://127.0.0.1:3000',
        changeOrigin: true,
      }
    }
  }
})
</file>

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
repomix-output.xml
</file>

<file path="package.json">
{
  "name": "data-dict-frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vue-tsc -b && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@element-plus/icons-vue": "^2.3.2",
    "axios": "^1.13.2",
    "element-plus": "^2.13.1",
    "pinia": "^3.0.4",
    "vue": "^3.5.24",
    "vue-router": "^4.6.4"
  },
  "devDependencies": {
    "@types/node": "^24.10.1",
    "@vitejs/plugin-vue": "^6.0.3",
    "@vue/tsconfig": "^0.8.1",
    "typescript": "~5.9.3",
    "vite": "^7.2.4",
    "vue-tsc": "^3.1.4"
  }
}
</file>

<file path="README.md">
ä¼ä¸šçº§å…ƒæ•°æ®ç®¡ç†çš„æ ‡å‡†æµç¨‹ï¼šâ€œç”¨æˆ·æ¶ˆè´¹æ•°æ®ã€ç®¡ç†å‘˜ç”Ÿäº§æ ‡å‡†â€

ç³»ç»Ÿåˆ’åˆ†ä¸ºä¸¤ä¸ªæ ¸å¿ƒè§†å›¾ï¼šã€ç”¨æˆ·æŸ¥è¯¢ç«¯ã€‘ å’Œ ã€ç®¡ç†å‘˜ç®¡ç†ç«¯ã€‘

ä¸šåŠ¡é€»è¾‘æµç¨‹å›¾
ç”¨æˆ·è§†è§’ (æŸ¥è¯¢é€»è¾‘)ï¼š
è¾“å…¥ä¸­æ–‡å -> åç«¯æŸ¥è¯¢ standard_fields (æ ‡å‡†å­—æ®µåº“)ã€‚
å‘½ä¸­ï¼šå±•ç¤ºå¯¹åº”çš„è‹±æ–‡åã€æ•°æ®ç±»å‹ã€‚
æœªå‘½ä¸­ï¼šçº¢è‰²è­¦å‘Šâ€œæœªæ‰¾åˆ°æ ‡å‡†å®šä¹‰â€ï¼Œæä¾›ä¸€ä¸ªã€ç”³è¯·æ–°å¢ã€‘æŒ‰é’®ã€‚
ç‚¹å‡»ç”³è¯·ï¼šå‘ notification_tasks å†™å…¥ä¸€æ¡ä»»åŠ¡ã€‚
ç®¡ç†å‘˜è§†è§’ (ç”Ÿäº§é€»è¾‘)ï¼š
è¿›å…¥â€œæ™ºèƒ½å‘½åâ€ -> è¾“å…¥ä¸­æ–‡ -> ç³»ç»Ÿè°ƒç”¨ jieba åˆ†è¯ã€‚
å…¨åŒ¹é…ï¼šæ‰€æœ‰åˆ†è¯éƒ½æœ‰è¯æ ¹ -> è‡ªåŠ¨ç»„åˆè‹±æ–‡å -> å…è®¸ç‚¹å‡»ã€æ­£å¼å…¥åº“ã€‘ã€‚
éƒ¨åˆ†ç¼ºå¤±ï¼šå­˜åœ¨æ— è¯æ ¹çš„è¯æ®µ -> ç¦æ­¢å…¥åº“ -> å¼•å¯¼ç®¡ç†å‘˜å…ˆå»ã€æ–°å¢è¯æ ¹ã€‘ã€‚
</file>

<file path="src/components/SmartMapper.vue">
<template>
  <div class="mapper-container">
    <el-card class="main-card">
      <template #header>
        <div class="card-header">
          <div class="header-left">
            <el-icon class="icon-magic"><MagicStick /></el-icon>
            <span class="title">æ ‡å‡†å­—æ®µç”Ÿäº§å° (ç®¡ç†å‘˜)</span>
          </div>
          <el-tag type="warning" effect="light">ç”Ÿäº§ç¯å¢ƒé€»è¾‘ï¼šæ— è¯æ ¹ä¸å…¥åº“</el-tag>
        </div>
      </template>

      <el-form label-position="top">
        <!-- 1. è¾“å…¥å¾…å½•å…¥çš„ä¸­æ–‡åç§° -->
        <el-form-item>
          <template #label>
            <div class="label-with-tip">
              <span>è¾“å…¥å­—æ®µä¸­æ–‡åç§°</span>
              <small>ç³»ç»Ÿå°†åŸºäºè¯æ ¹åº“è¿›è¡Œæ™ºèƒ½åˆ‡è¯å¹¶åŒ¹é…ç¼©å†™</small>
            </div>
          </template>
          <el-input
            v-model="cnInput"
            placeholder="ä¾‹å¦‚ï¼šæ”¶è´§äººç”µè¯"
            size="large"
            @input="handleInput"
            clearable
          />
        </el-form-item>

        <!-- 2. åˆ†è¯ä¸åŒ¹é…ç»“æœé¢„è§ˆ -->
        <div v-if="cnInput" class="mapping-result-box">
          <div class="section-title">åˆ†è¯åŒ¹é…é¢„è§ˆï¼š</div>
          <div class="suggestion-row">
            <el-input
              v-model="suggestedEn"
              readonly
              class="en-display-input"
              size="large"
            >
              <template #prefix>EN:</template>
            </el-input>
            
            <!-- å…¥åº“æŒ‰é’®ï¼šåªæœ‰å½“æ²¡æœ‰ä»»ä½•ç¼ºå¤±è¯æ ¹æ—¶æ‰å¯ç”¨ -->
            <el-button 
              type="primary" 
              size="large"
              :disabled="hasMissingRoots || !suggestedEn" 
              @click="openAdoptDialog"
            >
              æ­£å¼å…¥åº“
            </el-button>
          </div>

          <!-- 3. çŠ¶æ€é¢„è­¦ï¼šç¼ºå¤±è¯æ ¹æé†’ -->
          <div v-if="hasMissingRoots" class="error-alert">
            <el-alert 
              title="æ— æ³•å…¥åº“ï¼šæ£€æµ‹åˆ°æœªæ ‡å‡†åŒ–çš„è¯æ®µ" 
              type="error" 
              :closable="false" 
              show-icon
            >
              <template #default>
                <div class="missing-content">
                  <p>ä»¥ä¸‹è¯è¯­å°šæœªå½•å…¥â€œæ ‡å‡†è¯æ ¹åº“â€ï¼Œè¯·å…ˆè¡¥å…¨è¯æ ¹åå†ç”Ÿæˆæ ‡å‡†å­—æ®µï¼š</p>
                  <div class="missing-tags">
                    <el-tag 
                      v-for="word in missingWords" 
                      :key="word" 
                      type="danger" 
                      effect="dark"
                      class="word-tag"
                    >
                      {{ word }}
                    </el-tag>
                  </div>
                  <div class="action-hint">
                    <el-button type="danger" link @click="goToRootManagement">
                      ğŸ‘‰ å‰å¾€è¯æ ¹ç®¡ç†è¡¥å…¨
                    </el-button>
                  </div>
                </div>
              </template>
            </el-alert>
          </div>

          <div v-else-if="suggestedEn" class="success-alert">
            <el-alert 
              title="ç¬¦åˆæ ‡å‡†ï¼šæ‰€æœ‰è¯æ®µå‡å·²æ‰¾åˆ°å¯¹åº”è¯æ ¹" 
              type="success" 
              :closable="false" 
              show-icon
            />
          </div>
        </div>
      </el-form>
    </el-card>

    <!-- å¼¹çª—ï¼šæ­£å¼å…¥åº“ -->
    <el-dialog v-model="dialogVisible" title="ç¡®è®¤å…¥åº“ï¼šæ ‡å‡†å­—æ®µå®šä¹‰" width="500px">
      <el-form :model="adoptForm" label-width="120px">
        <el-form-item label="æ ‡å‡†ä¸­æ–‡å">
          <el-input v-model="adoptForm.field_cn_name" readonly />
        </el-form-item>
        <el-form-item label="æ ‡å‡†è‹±æ–‡å">
          <el-input v-model="adoptForm.field_en_name" readonly />
        </el-form-item>
        <el-form-item label="æ•°æ®ç±»å‹">
          <el-select v-model="adoptForm.data_type" style="width: 100%">
            <el-option label="VARCHAR(100)" value="VARCHAR(100)" />
            <el-option label="INT" value="INT" />
            <el-option label="BIGINT" value="BIGINT" />
            <el-option label="DECIMAL(18,2)" value="DECIMAL(18,2)" />
            <el-option label="TIMESTAMP" value="TIMESTAMP" />
          </el-select>
        </el-form-item>
        <el-form-item label="å…³è”è¯æ ¹é“¾">
          <el-tag 
            v-for="id in matchedIds" 
            :key="id" 
            size="small" 
            style="margin-right: 5px"
          >
            RootID: {{ id }}
          </el-tag>
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="handleFinalSubmit" :loading="submitting">
          ç¡®è®¤å…¥åº“
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue';
import { MagicStick } from '@element-plus/icons-vue';
import { dictionaryApi } from '../api';
import { ElMessage } from 'element-plus';

// --- æ•°æ®å®šä¹‰ ---
const cnInput = ref('');
const suggestedEn = ref('');
const missingWords = ref<string[]>([]);
const matchedIds = ref<number[]>([]);

const dialogVisible = ref(false);
const submitting = ref(false);

const adoptForm = ref({
  field_cn_name: '',
  field_en_name: '',
  data_type: 'VARCHAR(100)',
  composition_ids: [] as number[]
});

// --- è®¡ç®—å±æ€§ ---
const hasMissingRoots = computed(() => missingWords.value.length > 0);

// --- é€»è¾‘å¤„ç† ---
let timer: any = null;
const handleInput = () => {
  if (timer) clearTimeout(timer);
  timer = setTimeout(async () => {
    if (!cnInput.value.trim()) {
      suggestedEn.value = '';
      missingWords.value = [];
      matchedIds.value = [];
      return;
    }

    try {
      // è¯·æ±‚åç«¯ï¼šåˆ†è¯å¹¶åŒ¹é…è¯æ ¹
      const { data } = await dictionaryApi.getSuggest(cnInput.value);
      suggestedEn.value = data.suggested_en;
      missingWords.value = data.missing_words;
      matchedIds.value = data.matched_ids;
    } catch (e) {
      console.error("æ™ºèƒ½å»ºè®®è¯·æ±‚å¤±è´¥");
    }
  }, 350);
};

// æ‰“å¼€å…¥åº“ç¡®è®¤çª—
const openAdoptDialog = () => {
  adoptForm.value = {
    field_cn_name: cnInput.value,
    field_en_name: suggestedEn.value,
    data_type: 'VARCHAR(100)',
    composition_ids: matchedIds.value
  };
  dialogVisible.value = true;
};

// æ­£å¼æäº¤å…¥åº“
const handleFinalSubmit = async () => {
  submitting.value = true;
  try {
    await dictionaryApi.createField(adoptForm.value);
    ElMessage.success('æ ‡å‡†å­—æ®µå·²æˆåŠŸå½•å…¥æ ‡å‡†åº“ï¼');
    dialogVisible.value = false;
    // é‡ç½®ç•Œé¢
    cnInput.value = '';
    suggestedEn.value = '';
    missingWords.value = [];
    matchedIds.value = [];
  } catch (error: any) {
    ElMessage.error('å…¥åº“å¤±è´¥');
  } finally {
    submitting.value = false;
  }
};

const goToRootManagement = () => {
  ElMessage.info('è¯·åœ¨ä¾§è¾¹æ åˆ‡æ¢è‡³ [è¯æ ¹åº“ç®¡ç†] é¡µé¢è¿›è¡Œæ–°å¢');
  // å¦‚æœä½¿ç”¨äº† vue-routerï¼Œè¿™é‡Œå¯ä»¥ router.push('/roots')
};
</script>

<style scoped>
.mapper-container {
  max-width: 800px;
  margin: 30px auto;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

.icon-magic {
  color: #409eff;
  font-size: 20px;
}

.title {
  font-weight: bold;
  font-size: 16px;
}

.label-with-tip {
  display: flex;
  flex-direction: column;
}

.label-with-tip small {
  color: #999;
  font-weight: normal;
}

.mapping-result-box {
  margin-top: 20px;
  padding: 20px;
  background-color: #fafafa;
  border-radius: 8px;
  border: 1px solid #eee;
}

.section-title {
  font-size: 13px;
  color: #666;
  margin-bottom: 12px;
}

.suggestion-row {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
}

.en-display-input :deep(.el-input__wrapper) {
  background-color: #f0f7ff;
  font-family: 'Consolas', monospace;
  font-weight: bold;
}

.error-alert {
  border: 1px solid #f8d7da;
}

.missing-content p {
  margin: 0 0 10px 0;
  font-size: 13px;
}

.missing-tags {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.word-tag {
  font-weight: bold;
}

.action-hint {
  margin-top: 15px;
  border-top: 1px dashed #fab6b6;
  padding-top: 10px;
}

.success-alert {
  border: 1px solid #c3e6cb;
}
</style>
</file>

<file path="src/main.ts">
import { createApp } from 'vue'
import App from './App.vue'
import router from './router' // å¼•å…¥è·¯ç”±
import ElementPlus from 'element-plus'
import 'element-plus/dist/index.css'

const app = createApp(App)
app.use(router) // ä½¿ç”¨è·¯ç”±
app.use(ElementPlus)
app.mount('#app')
</file>

<file path="src/router/index.ts">
import { createRouter, createWebHistory, type RouteRecordRaw } from 'vue-router';

// å®šä¹‰è·¯ç”±è§„åˆ™
const routes: Array<RouteRecordRaw> = [
  // 1. å…¬å…±å…¥å£ï¼šç”¨æˆ·æŸ¥è¯¢é—¨æˆ·
  {
    path: '/',
    name: 'UserSearch',
    component: () => import('../views/UserSearch.vue'),
    meta: { title: 'æ ‡å‡†æŸ¥è¯¢é—¨æˆ·' }
  },
  
  // 2. èº«ä»½è®¤è¯é¡µ
  {
    path: '/login',
    name: 'Login',
    component: () => import('../views/Login.vue'),
    meta: { title: 'ç³»ç»Ÿç™»å½•' }
  },
  {
    path: '/signup',
    name: 'Signup',
    component: () => import('../views/Signup.vue'),
    meta: { title: 'ç”¨æˆ·æ³¨å†Œ' }
  },

  // 3. ç®¡ç†å‘˜åå°ï¼ˆåµŒå¥—è·¯ç”±ï¼‰
  {
    path: '/admin',
    component: () => import('../layouts/AdminLayout.vue'),
    redirect: '/admin/fields', // è®¿é—® /admin æ—¶è‡ªåŠ¨è·³è½¬åˆ°å­—æ®µç®¡ç†
    meta: { requiresAuth: true, requiresAdmin: true }, // æ ‡è®°éœ€è¦æƒé™
    children: [
      {
        path: 'fields',
        name: 'StandardFieldList',
        component: () => import('../views/StandardFieldList.vue'),
        meta: { title: 'æ ‡å‡†å­—æ®µç®¡ç†' }
      },
      {
        path: 'roots',
        name: 'WordRootList',
        component: () => import('../views/WordRootList.vue'),
        meta: { title: 'æ ‡å‡†è¯æ ¹ç®¡ç†' }
      },
      {
        path: 'users',
        name: 'UserManagement',
        component: () => import('../views/UserManagement.vue'),
        meta: { title: 'ç”¨æˆ·æƒé™ç®¡ç†' }
      }
    ]
  },

  // 4. 404 å…œåº•ï¼ˆå¯é€‰ï¼‰
  {
    path: '/:pathMatch(.*)*',
    redirect: '/'
  }
];

const router = createRouter({
  history: createWebHistory(),
  routes
});

/**
 * å…¨å±€è·¯ç”±å®ˆå«
 * è´Ÿè´£ï¼šé¡µé¢æ ‡é¢˜æ›´æ–°ã€ç™»å½•æ‹¦æˆªã€è§’è‰²æƒé™æ§åˆ¶
 */
router.beforeEach((to, _from, next) => {
  // 1. åŠ¨æ€æ›´æ–°æµè§ˆå™¨é¡µç­¾æ ‡é¢˜
  if (to.meta.title) {
    document.title = `${to.meta.title} - æ•°æ®å­—å…¸ç³»ç»Ÿ`;
  }

  // 2. è·å–æœ¬åœ°å­˜å‚¨çš„ç™»å½•çŠ¶æ€
  const token = localStorage.getItem('token');
  const role = localStorage.getItem('role');

  // 3. æƒé™åˆ¤æ–­é€»è¾‘
  if (to.matched.some(record => record.meta.requiresAuth)) {
    // æ£€æŸ¥æ˜¯å¦ç™»å½•
    if (!token) {
      next({
        path: '/login',
        query: { redirect: to.fullPath } // ç™»å½•åè·³è½¬å›å½“å‰é¡µ
      });
    } 
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜è§’è‰²
    else if (to.matched.some(record => record.meta.requiresAdmin) && role !== 'admin') {
      // å¦‚æœä¸æ˜¯ç®¡ç†å‘˜ï¼Œå¼ºåˆ¶è¸¢å›æ™®é€šæŸ¥è¯¢é¡µ
      alert('æƒé™ä¸è¶³ï¼šæ‚¨çš„è´¦å·ä¸æ˜¯ç®¡ç†å‘˜è§’è‰²ï¼Œæ— æ³•è¿›å…¥åå°ã€‚');
      next('/');
    } 
    else {
      next(); // éªŒè¯é€šè¿‡
    }
  } else {
    // å…¬å…±é¡µé¢ï¼Œå¦‚æœå·²ç™»å½•ä¸”è®¿é—® login é¡µï¼Œç›´æ¥è·³åå°
    if (to.path === '/login' && token && role === 'admin') {
      next('/admin/fields');
    } else {
      next();
    }
  }
});

export default router;
</file>

<file path="src/views/Login.vue">
<template>
  <div class="login-container">
    <el-card class="login-card">
      <template #header>
        <div class="login-title">æ•°æ®æ ‡å‡†ç³»ç»Ÿç™»å½•</div>
      </template>

      <el-form :model="form" @keyup.enter="handleLogin">
        <el-form-item>
          <!-- è¿™é‡Œä½¿ç”¨å›¾æ ‡ç»„ä»¶ -->
          <el-input v-model="form.username" placeholder="ç”¨æˆ·å">
            <template #prefix><el-icon>
                <User />
              </el-icon></template>
          </el-input>
        </el-form-item>

        <el-form-item>
          <el-input v-model="form.password" type="password" placeholder="å¯†ç " show-password>
            <template #prefix><el-icon>
                <Lock />
              </el-icon></template>
          </el-input>
        </el-form-item>

        <el-button type="primary" :loading="loading" @click="handleLogin" class="w-full">
          ç™»å½•ç³»ç»Ÿ
        </el-button>
      </el-form>
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { reactive, ref } from 'vue';
import { dictionaryApi } from '../api';
import { useRouter } from 'vue-router';
import { ElMessage } from 'element-plus';
// ç¡®ä¿è¿™äº›å›¾æ ‡è¢«æ¨¡æ¿ç”¨åˆ°
import { User, Lock } from '@element-plus/icons-vue';

const router = useRouter();
const loading = ref(false);

const form = reactive({
  username: '',
  password: ''
});

const handleLogin = async () => {
  if (!form.username || !form.password) {
    ElMessage.warning('è¯·å®Œæ•´å¡«å†™ä¿¡æ¯');
    return;
  }

  loading.value = true;
  try {
    const { data } = await dictionaryApi.login(form);

    // æ ¸å¿ƒï¼šå­˜å‚¨å‡­è¯
    localStorage.setItem('token', data.token);
    localStorage.setItem('role', data.role);

    ElMessage.success('æ¬¢è¿å›æ¥');

    if (data.role === 'admin') {
      // ç®¡ç†å‘˜å»åå°
      router.push('/admin/fields');
    } else {
      // æ™®é€šç”¨æˆ·å»æŸ¥è¯¢é¡µ
      router.push('/');
    }
  } catch (error: any) {
    console.error(error);
    ElMessage.error(error.response?.data || 'ç™»å½•éªŒè¯å¤±è´¥');
  } finally {
    loading.value = false;
  }
};
</script>

<style scoped>
.login-container {
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: #2d3a4b;
}

.login-card {
  width: 400px;
}

.login-title {
  text-align: center;
  font-size: 18px;
  font-weight: bold;
}

.w-full {
  width: 100%;
}
</style>
</file>

<file path="src/App.vue">
<template>
  <!-- å…¨å±€æ ¹è§†å›¾å‡ºå£ -->
  <router-view />
</template>

<script setup lang="ts">
// æ ¹ç»„ä»¶ä¸å†å¤„ç†ä¸šåŠ¡é€»è¾‘
</script>

<style>
body { margin: 0; padding: 0; background-color: #f0f2f5; }
</style>
</file>

<file path="src/layouts/AdminLayout.vue">
<template>
  <el-container class="admin-layout">
    <!-- å·¦ä¾§å¯¼èˆª -->
    <el-aside width="240px" class="aside-menu">
      <div class="logo-box">
        <el-icon class="logo-icon"><DataLine /></el-icon>
        <span class="logo-text">å­—å…¸ç®¡ç†ç³»ç»Ÿ</span>
      </div>

      <el-menu
        :default-active="activePath"
        class="el-menu-vertical"
        background-color="#304156"
        text-color="#bfcbd9"
        active-text-color="#409EFF"
        router
      >
        <el-menu-item index="/admin/fields">
          <el-icon><DataAnalysis /></el-icon>
          <span>æ ‡å‡†å­—æ®µç®¡ç†</span>
        </el-menu-item>
        <el-menu-item index="/admin/roots">
          <el-icon><Collection /></el-icon>
          <span>æ ‡å‡†è¯æ ¹åº“</span>
        </el-menu-item>
        <el-menu-item index="/admin/users">
          <el-icon><UserFilled /></el-icon>
          <span>ç”¨æˆ·æƒé™ç®¡ç†</span>
        </el-menu-item>

      </el-menu>
    </el-aside>

    <el-container>
      <!-- é¡¶æ  -->
      <el-header class="admin-header">
        <div class="header-left">
          <el-breadcrumb separator="/">
            <el-breadcrumb-item :to="{ path: '/' }">é¦–é¡µ</el-breadcrumb-item>
            <el-breadcrumb-item>{{ currentRouteTitle }}</el-breadcrumb-item>
          </el-breadcrumb>
        </div>

        <!-- é€€å‡ºç™»å½•åŒºåŸŸ -->
        <div class="header-right">
          <el-dropdown @command="handleCommand" trigger="click">
            <span class="user-info">
              <span class="username">ç®¡ç†å‘˜</span>
              <el-icon class="el-icon--right"><arrow-down /></el-icon>
            </span>
            <template #dropdown>
              <el-dropdown-menu>
                <el-dropdown-item divided command="logout" class="logout-item">
                  <el-icon><SwitchButton /></el-icon>é€€å‡ºç™»å½•
                </el-dropdown-item>
              </el-dropdown-menu>
            </template>
          </el-dropdown>
        </div>
      </el-header>

      <!-- ä¸»å†…å®¹ -->
      <el-main class="admin-main">
        <router-view v-slot="{ Component }">
          <transition name="fade-transform" mode="out-in">
            <keep-alive>
              <component :is="Component" />
            </keep-alive>
          </transition>
        </router-view>
      </el-main>
    </el-container>
  </el-container>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import { 
  DataAnalysis, 
  Collection, 
  DataLine, 
  UserFilled, 
  ArrowDown, 
  SwitchButton 
} from '@element-plus/icons-vue';
import { ElMessageBox, ElMessage } from 'element-plus';

const route = useRoute();
const router = useRouter();

const activePath = computed(() => route.path);
const currentRouteTitle = computed(() => route.meta.title || 'åå°ç®¡ç†');

// å¤„ç†ä¸‹æ‹‰èœå•å‘½ä»¤
const handleCommand = (command: string) => {
  if (command === 'logout') {
    handleLogout();
  }
};

// é€€å‡ºç™»å½•é€»è¾‘
const handleLogout = () => {
  ElMessageBox.confirm(
    'ç¡®è®¤é€€å‡ºç³»ç»Ÿç®¡ç†åå°å—ï¼Ÿ',
    'æç¤º',
    {
      confirmButtonText: 'ç¡®å®š',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning',
    }
  ).then(() => {
    // 1. æ¸…é™¤æœ¬åœ°å­˜å‚¨
    localStorage.removeItem('token');
    localStorage.removeItem('role');
    
    // 2. æç¤ºå¹¶è·³è½¬
    ElMessage.success('å·²å®‰å…¨é€€å‡º');
    router.push('/login');
  }).catch(() => {
    // å–æ¶ˆé€€å‡º
  });
};
</script>

<style scoped>
.admin-layout { height: 100vh; }
.aside-menu { background-color: #304156; transition: width 0.3s; }
.logo-box { 
  height: 60px; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  background: #2b2f3a; 
  color: #fff; 
}
.logo-icon { font-size: 24px; color: #409EFF; margin-right: 10px; }
.logo-text { font-size: 16px; font-weight: bold; }

.el-menu-vertical { border-right: none; }

.admin-header { 
  background: #fff; 
  border-bottom: 1px solid #e6e6e6; 
  display: flex; 
  align-items: center; 
  justify-content: space-between;
  padding: 0 20px;
  height: 60px;
}

.user-info {
  display: flex;
  align-items: center;
  cursor: pointer;
  padding: 5px 8px;
  border-radius: 4px;
  transition: background 0.3s;
}

.user-info:hover {
  background: #f6f6f6;
}

.avatar { background: #409eff; margin-right: 8px; }
.username { font-size: 14px; color: #606266; margin-right: 4px; }

.logout-item { color: #f56c6c; }

.admin-main {
  background-color: #f0f2f5;
  padding: 20px;
}

/* ç®€å•çš„è¿‡æ¸¡åŠ¨ç”» */
.fade-transform-enter-active,
.fade-transform-leave-active {
  transition: all 0.3s;
}
.fade-transform-enter-from {
  opacity: 0;
  transform: translateX(-20px);
}
.fade-transform-leave-to {
  opacity: 0;
  transform: translateX(20px);
}
</style>
</file>

<file path="src/types/index.ts">
export interface AuthPayload {
  username: string;
  password: string;
}

export interface AuthResponse {
  token: string;
  role: string;
}

export interface WordRoot {
  id?: number;
  cn_name: string;
  en_abbr: string;
  en_full_name?: string;
  associated_terms?: string;
  remark?: string;
  created_at?: string;
}

export interface SuggestResponse {
  suggested_en: string;
  missing_words: string[];
  matched_ids: number[];
}

export interface StandardField {
  id?: number;
  field_cn_name: string;
  field_en_name: string;
  composition_ids: number[];
  data_type: string;
  associated_terms?: string;
  is_standard: boolean;
  created_at?: string;
}
</file>

<file path="src/views/StandardFieldList.vue">
<template>
  <div class="field-container">
    <!-- é¡¶éƒ¨æ“ä½œæ  -->
    <div class="toolbar">
      <div class="left">
        <el-input
          v-model="searchQuery"
          placeholder="æœç´¢æ ‡å‡†åæˆ–åŒä¹‰è¯..."
          style="width: 320px"
          :prefix-icon="Search"
          clearable
        />
      </div>
      <div class="right">
        <el-button type="primary" :icon="Plus" @click="openAddDialog">
          æ–°å¢æ ‡å‡†å­—æ®µ
        </el-button>
      </div>
    </div>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <el-table :data="filteredFields" border v-loading="loading" row-key="id" style="width: 100%">
      <el-table-column prop="id" label="ID" width="70" />
      <el-table-column prop="field_cn_name" label="æ ‡å‡†ä¸­æ–‡å" width="180" />
      <el-table-column prop="field_en_name" label="è‹±æ–‡æ ‡å‡†å" width="220">
        <template #default="{ row }">
          <code class="en-code">{{ row.field_en_name }}</code>
        </template>
      </el-table-column>
      <el-table-column prop="associated_terms" label="åŒä¹‰è¯/å…³è”è¯" show-overflow-tooltip />
      <el-table-column prop="data_type" label="æ•°æ®ç±»å‹" width="130" />
      <el-table-column label="æ“ä½œ" width="200" fixed="right">
        <template #default="{ row }">
          <el-button link type="primary" @click="handleEdit(row)">ç¼–è¾‘</el-button>
          <el-button link type="info" @click="showDetail(row)">ç»„æˆè¯¦æƒ…</el-button>
          <el-popconfirm title="ç¡®å®šåˆ é™¤è¯¥æ ‡å‡†å­—æ®µå—ï¼Ÿ" @confirm="handleDelete(row.id)">
            <template #reference>
              <el-button link type="danger">åˆ é™¤</el-button>
            </template>
          </el-popconfirm>
        </template>
      </el-table-column>
    </el-table>

    <!-- æ–°å¢/ç¼–è¾‘å¼¹çª— -->
    <el-dialog
      v-model="dialogVisible"
      :title="form.id ? 'ä¿®æ”¹æ ‡å‡†å­—æ®µ' : 'æ–°å¢æ ‡å‡†å­—æ®µ'"
      width="600px"
      @closed="resetForm"
    >
      <el-form :model="form"  label-width="110px" ref="formRef" :rules="rules">
        <el-form-item label="æ ‡å‡†ä¸­æ–‡å" prop="field_cn_name">
          <el-input 
            v-model="form.field_cn_name" 
            placeholder="å¦‚ï¼šæ”¶è´§äººæ‰‹æœºå·" 
            @input="handleAnalyze"
          />
        </el-form-item>

        <!-- æ ¸å¿ƒä¸šåŠ¡çº¦æŸå±•ç¤ºåŒº -->
        <div class="analysis-box">
          <div class="box-title">è¯æ ¹ç»„åˆæ ¡éªŒç»“æœï¼š</div>
          
          <!-- æƒ…å†µAï¼šå­˜åœ¨ç¼ºå¤±è¯æ ¹ -->
          <div v-if="missingWords.length > 0" class="status-error">
            <el-alert type="error" :closable="false" show-icon>
              <template #title>
                æ— æ³•ç”Ÿæˆï¼šè¯é¡¹ [ {{ missingWords.join(', ') }} ] æœªæ ‡å‡†åŒ–
              </template>
              <p>è¯·å…ˆåœ¨â€œè¯æ ¹ç®¡ç†â€ä¸­å½•å…¥ä»¥ä¸Šè¯æ±‡ï¼Œå¦åˆ™æ— æ³•åˆ›å»ºæ ‡å‡†å­—æ®µã€‚</p>
            </el-alert>
          </div>

          <!-- æƒ…å†µBï¼šè§£ææˆåŠŸ -->
          <div v-else-if="form.field_en_name" class="status-success">
            <el-alert type="success" :closable="false" show-icon>
              <template #title>
                éªŒè¯é€šè¿‡ï¼šç”Ÿæˆçš„è‹±æ–‡åä¸º <b>{{ form.field_en_name }}</b>
              </template>
              <div class="root-chain">
                å…³è”è¯æ ¹IDé“¾: 
                <el-tag v-for="id in matchedIds" :key="id" size="small" class="id-tag">
                  {{ id }}
                </el-tag>
              </div>
            </el-alert>
          </div>
          
          <div v-else class="status-empty">ç­‰å¾…è¾“å…¥ä¸­æ–‡åè¿›è¡Œè§£æ...</div>
        </div>

        <el-form-item label="åŒä¹‰è¯" prop="associated_terms">
          <el-input 
            v-model="form.associated_terms" 
            placeholder="ç”¨é€—å·éš”å¼€ï¼Œç”¨äºç”¨æˆ·æ¨¡ç³Šæœç´¢ï¼Œå¦‚ï¼šæ‰‹æœº,ç§»åŠ¨ç”µè¯" 
          />
        </el-form-item>

        <el-form-item label="æ•°æ®ç±»å‹" prop="data_type">
          <el-select v-model="form.data_type" placeholder="é€‰æ‹©å­—æ®µæ•°æ®ç±»å‹" style="width: 100%">
            <el-option label="VARCHAR(50)" value="VARCHAR(50)" />
            <el-option label="VARCHAR(100)" value="VARCHAR(100)" />
            <el-option label="INT" value="INT" />
            <el-option label="BIGINT" value="BIGINT" />
            <el-option label="DECIMAL(18,2)" value="DECIMAL(18,2)" />
            <el-option label="TIMESTAMP" value="TIMESTAMP" />
            <el-option label="BOOLEAN" value="BOOLEAN" />
          </el-select>
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
        <el-button 
          type="primary" 
          @click="submitForm" 
          :loading="submitting"
          :disabled="missingWords.length > 0 || !form.field_en_name"
        >
          ç¡®è®¤æäº¤
        </el-button>
      </template>
    </el-dialog>

    <!-- ç»„æˆè¯¦æƒ…æŠ½å±‰ -->
    <el-drawer v-model="drawerVisible" title="æ ‡å‡†å­—æ®µç»„æˆè§£æ" size="400px">
      <div v-if="selectedField" class="detail-content">
        <el-descriptions :column="1" border>
          <el-descriptions-item label="ä¸­æ–‡åç§°">{{ selectedField.field_cn_name }}</el-descriptions-item>
          <el-descriptions-item label="è‹±æ–‡åç§°">{{ selectedField.field_en_name }}</el-descriptions-item>
        </el-descriptions>
        
        <h4 style="margin-top: 25px">åŸå­è¯æ ¹é“¾ (Composition)</h4>
        <el-timeline style="margin-top: 15px">
          <el-timeline-item
            v-for="root in detailRoots"
            :key="root.id"
            :timestamp="root.en_abbr"
            placement="top"
            type="primary"
          >
            <el-card shadow="never">
              <div style="font-weight: bold">{{ root.cn_name }}</div>
              <div style="font-size: 12px; color: #999; margin-top: 5px">
                ID: {{ root.id }} | {{ root.remark || 'æ— å¤‡æ³¨' }}
              </div>
            </el-card>
          </el-timeline-item>
        </el-timeline>
      </div>
    </el-drawer>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, computed } from 'vue';
import { Plus, Search } from '@element-plus/icons-vue';
import { dictionaryApi } from '../api';
import type { StandardField, WordRoot } from '../types';
import { ElMessage } from 'element-plus';

const formRef = ref();
// --- çŠ¶æ€å˜é‡ ---
const loading = ref(false);
const submitting = ref(false);
const fields = ref<StandardField[]>([]);
const searchQuery = ref('');

const dialogVisible = ref(false);
const drawerVisible = ref(false);

const missingWords = ref<string[]>([]);
const matchedIds = ref<number[]>([]);

const form = ref<any>({
  id: undefined,
  field_cn_name: '',
  field_en_name: '',
  associated_terms: '',
  data_type: 'VARCHAR(100)',
  composition_ids: []
});

const rules = {
  field_cn_name: [{ required: true, message: 'è¯·è¾“å…¥ä¸­æ–‡å…¨ç§°', trigger: 'blur' }],
  data_type: [{ required: true, message: 'è¯·é€‰æ‹©æ•°æ®ç±»å‹', trigger: 'change' }]
};

const selectedField = ref<StandardField | null>(null);
const detailRoots = ref<WordRoot[]>([]);

// --- æ ¸å¿ƒé€»è¾‘ ---

// è·å–å­—æ®µåˆ—è¡¨
const fetchFields = async () => {
  loading.value = true;
  try {
    const { data } = await dictionaryApi.getFields();
    // ç¡®ä¿ç›´æ¥è¦†ç›–äº† fields.value
    fields.value = data; 
  } catch (e) {
    ElMessage.error('è·å–åˆ—è¡¨å¤±è´¥');
  } finally {
    loading.value = false;
  }
};



// åˆ—è¡¨è¿‡æ»¤é€»è¾‘
const filteredFields = computed(() => {
  const q = searchQuery.value.toLowerCase().trim();
  if (!q) return fields.value;
  return fields.value.filter(f => 
    f.field_cn_name.toLowerCase().includes(q) || 
    f.field_en_name.toLowerCase().includes(q) ||
    (f.associated_terms && f.associated_terms.toLowerCase().includes(q))
  );
});

// æ ¸å¿ƒï¼šå¤„ç†è§£æå»ºè®® (ç®¡ç†å‘˜å½•å…¥æ—¶çš„å¼ºæ ¡éªŒ)
let timer: any = null;
const handleAnalyze = () => {
  if (timer) clearTimeout(timer);
  timer = setTimeout(async () => {
    if (!form.value.field_cn_name) {
      form.value.field_en_name = '';
      missingWords.value = [];
      matchedIds.value = [];
      return;
    }
    try {
      const { data } = await dictionaryApi.getSuggest(form.value.field_cn_name);
      form.value.field_en_name = data.suggested_en;
      missingWords.value = data.missing_words;
      // è¿™é‡Œçš„ data.matched_ids å¿…é¡»èµ‹å€¼ç»™ matchedIds.value
      matchedIds.value = data.matched_ids || []; 
      console.log("åˆ†æå®Œæˆï¼Œæ‹¿åˆ° ID é“¾:", matchedIds.value);
    } catch (e) {
      console.error("è§£æå¤±è´¥", e);
    }
  }, 400);
};

// ä¿å­˜å­—æ®µ
const submitForm = async () => {
  if (!formRef.value) return;
  
  await formRef.value.validate(async (valid: boolean) => {
    if (valid) {
      submitting.value = true;
      try {
        // ã€å…³é”®æ”¹åŠ¨ã€‘æ‰‹åŠ¨ç»„è£… payloadï¼Œç¡®ä¿ composition_ids ä¸ä¸ºç©º
        const payload = {
          ...form.value,
          composition_ids: matchedIds.value // å¼ºåˆ¶è¦†ç›–
        };
        
        console.log("å‡†å¤‡æäº¤çš„æ•°æ®:", payload);

        if (form.value.id) {
          await dictionaryApi.updateField(form.value.id, payload);
        } else {
          await dictionaryApi.createField(payload);
        }

        ElMessage.success('ä¿å­˜æˆåŠŸ');
        dialogVisible.value = false;
        await fetchFields(); 
      } catch (error: any) {
        ElMessage.error('ä¿å­˜å¤±è´¥');
      } finally {
        submitting.value = false;
      }
    }
  });
};

// åˆ é™¤å­—æ®µ
const handleDelete = async (id: number) => {
  try {
    await dictionaryApi.deleteField(id);
    ElMessage.success('å·²åˆ é™¤');
    // åˆ é™¤åå¿…é¡»é‡æ–°è·å–åˆ—è¡¨
    await fetchFields(); 
  } catch (e) {
    ElMessage.error('åˆ é™¤å¤±è´¥');
  }
};

// æŸ¥çœ‹è¯¦æƒ…ï¼ˆç»„æˆè§£æï¼‰
const showDetail = async (row: StandardField) => {
    selectedField.value = row;
    detailRoots.value = []; // å…ˆæ¸…ç©ºï¼Œé˜²æ­¢çœ‹åˆ°ä¸Šä¸€ä¸ªå­—æ®µçš„è¯æ ¹
    drawerVisible.value = true;
    try {
        const { data } = await dictionaryApi.getFieldDetails(row.id!);
        console.log("è·å–åˆ°çš„è¯æ ¹é“¾æ¡:", data); // è°ƒè¯•ç”¨
        detailRoots.value = data;
    } catch (e) {
        ElMessage.error("åŠ è½½è¯¦æƒ…å¤±è´¥");
    }
};

// å¼¹çª—æ§åˆ¶
const openAddDialog = () => {
  resetForm();
  dialogVisible.value = true;
};

const handleEdit = (row: StandardField) => {
  form.value = { ...row };
  // ç¼–è¾‘æ—¶ä¹Ÿéœ€è¦è¿è¡Œä¸€éè§£æé€»è¾‘ä»¥åŒæ­¥ ID é“¾å’Œè‹±æ–‡åçŠ¶æ€
  handleAnalyze(); 
  dialogVisible.value = true;
};

const resetForm = () => {
  form.value = {
    id: undefined,
    field_cn_name: '',
    field_en_name: '',
    associated_terms: '',
    data_type: 'VARCHAR(100)',
    composition_ids: []
  };
  missingWords.value = [];
  matchedIds.value = [];
};

onMounted(fetchFields);
</script>

<style scoped>
.field-container {
  padding: 10px;
}

.toolbar {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
}

.en-code {
  background: #f0f7ff;
  color: #409eff;
  padding: 3px 8px;
  border-radius: 4px;
  font-family: 'Consolas', monospace;
  font-weight: bold;
}

.analysis-box {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin: 0 0 20px 110px;
  border: 1px dashed #dcdfe6;
}

.box-title {
  font-size: 12px;
  color: #909399;
  margin-bottom: 10px;
}

.status-empty {
  color: #c0c4cc;
  font-size: 13px;
  text-align: center;
}

.root-chain {
  margin-top: 8px;
  font-size: 12px;
  color: #666;
}

.id-tag {
  margin: 0 2px;
}

.detail-content {
  padding: 0 10px;
}
</style>
</file>

<file path="src/views/WordRootList.vue">
<template>
  <div class="root-container">
    <!-- æ“ä½œæ  -->
    <div class="toolbar">
      <el-input v-model="searchQuery" placeholder="æœç´¢ä¸­æ–‡åæˆ–è‹±æ–‡ç¼©å†™" style="width: 300px" clearable @input="handleSearch" />
      <el-button type="primary" :icon="Plus" @click="openAddDialog">
        æ–°å¢è¯æ ¹
      </el-button>
    </div>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <el-table :data="filteredRoots" border v-loading="loading" style="width: 100%">
      <el-table-column prop="id" label="ID" width="80" />
      <el-table-column prop="cn_name" label="ä¸­æ–‡åç§°" width="150" />
      <el-table-column prop="en_abbr" label="è‹±æ–‡ç¼©å†™" width="150">
        <template #default="{ row }">
          <code class="en-code">{{ row.en_abbr }}</code>
        </template>
      </el-table-column>
      <el-table-column prop="associated_terms" label="åŒä¹‰è¯" show-overflow-tooltip />
      <el-table-column prop="remark" label="å¤‡æ³¨" />
      <el-table-column prop="created_at" label="åˆ›å»ºæ—¶é—´" width="180">
        <template #default="{ row }">
          {{ row.created_at ? new Date(row.created_at).toLocaleString() : '-' }}
        </template>
      </el-table-column>

      <el-table-column label="æ“ä½œ" width="150">
        <template #default="{ row }">
          <el-button link type="primary" @click="handleEdit(row)">ç¼–è¾‘</el-button>
          <el-popconfirm title="ç¡®å®šåˆ é™¤å—ï¼Ÿ" @confirm="handleDelete(row.id)">
            <template #reference>
              <el-button link type="danger">åˆ é™¤</el-button>
            </template>
          </el-popconfirm>
        </template>
      </el-table-column>
    </el-table>

    <!-- æ–°å¢/ç¼–è¾‘å¼¹çª— -->
    <el-dialog v-model="dialogVisible" :title="form.id ? 'ç¼–è¾‘è¯æ ¹' : 'æ–°å¢è¯æ ¹'" width="500px">
      <el-form :model="form" label-width="100px" ref="formRef" :rules="rules">
        <el-form-item label="ä¸­æ–‡åç§°" prop="cn_name">
          <el-input v-model="form.cn_name" placeholder="å¦‚ï¼šé‡‘é¢" />
        </el-form-item>
        <el-form-item label="è‹±æ–‡ç¼©å†™" prop="en_abbr">
          <el-input v-model="form.en_abbr" placeholder="å¦‚ï¼šamt" />
        </el-form-item>
        <el-form-item label="åŒä¹‰è¯" prop="associated_terms">
          <el-input v-model="form.associated_terms" placeholder="å¤šä¸ªç”¨é€—å·éš”å¼€ï¼Œå¦‚ï¼šé’±,è´¹ç”¨,ä»·æ ¼" />
        </el-form-item>
        <el-form-item label="å¤‡æ³¨">
          <el-input v-model="form.remark" type="textarea" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="saveRoot" :loading="submitting">ç¡®å®š</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, computed } from 'vue';
import { Plus } from '@element-plus/icons-vue';
import { dictionaryApi } from '../api';
import type { WordRoot } from '../types';
import { ElMessage } from 'element-plus';

const loading = ref(false);
const submitting = ref(false);
const roots = ref<WordRoot[]>([]);
const searchQuery = ref('');
const dialogVisible = ref(false);
const formRef = ref();

const form = ref<WordRoot>({
  cn_name: '',
  en_abbr: '',
  associated_terms: '',
  remark: ''
});

const rules = {
  cn_name: [{ required: true, message: 'è¯·è¾“å…¥ä¸­æ–‡åç§°', trigger: 'blur' }],
  en_abbr: [{ required: true, message: 'è¯·è¾“å…¥è‹±æ–‡ç¼©å†™', trigger: 'blur' }],
};

// è·å–æ•°æ®
const fetchRoots = async () => {
  loading.value = true; // ä¿®æ­£ï¼šè¿™é‡Œä¹‹å‰æ˜¯ loading.refï¼Œåº”æ”¹ä¸º .value
  try {
    const { data } = await dictionaryApi.getRoots();
    roots.value = data;
  } catch (error) {
    ElMessage.error('è·å–åˆ—è¡¨å¤±è´¥');
  } finally {
    loading.value = false;
  }
};

// æœç´¢å›è°ƒï¼ˆå¦‚æœ template ä¸­æœ‰ @input="handleSearch"ï¼‰
const handleSearch = () => {
  // filteredRoots æ˜¯è®¡ç®—å±æ€§ï¼Œä¼šè‡ªåŠ¨éš searchQuery å˜åŒ–
  // è¿™é‡Œå¯ä»¥ç•™ç©ºï¼Œæˆ–è€…æ”¾ä¸€äº›ç‰¹æ®Šçš„æœç´¢åŸ‹ç‚¹é€»è¾‘
  console.log('Searching for:', searchQuery.value);
};

// è¿‡æ»¤é€»è¾‘
const filteredRoots = computed(() => {
  const q = searchQuery.value.toLowerCase().trim();
  if (!q) return roots.value;
  return roots.value.filter(r =>
    r.cn_name.toLowerCase().includes(q) ||
    r.en_abbr.toLowerCase().includes(q) ||
    (r.associated_terms && r.associated_terms.toLowerCase().includes(q))
  );
});

const openAddDialog = () => {
  form.value = { cn_name: '', en_abbr: '', associated_terms: '', remark: '' };
  dialogVisible.value = true;
};

const handleEdit = (row: WordRoot) => {
  form.value = { ...row }; // æ‹·è´æ•°æ®
  dialogVisible.value = true;
};

const handleDelete = async (id: number) => {
  try {
    await dictionaryApi.deleteRoot(id);
    ElMessage.success('å·²åˆ é™¤');
    fetchRoots();
  } catch (e) { ElMessage.error('åˆ é™¤å¤±è´¥'); }
};

const saveRoot = async () => {
  if (!formRef.value) return;

  await formRef.value.validate(async (valid: boolean) => {
    if (valid) {
      submitting.value = true;
      try {
        // ã€æ ¸å¿ƒä¿®å¤ç‚¹ã€‘åˆ¤æ–­æ˜¯å¦æœ‰ id
        if (form.value.id) {
          // è°ƒç”¨ä¿®æ”¹æ¥å£ï¼šPUT /api/admin/roots/:id
          await dictionaryApi.updateRoot(form.value.id, form.value);
          ElMessage.success('ä¿®æ”¹æˆåŠŸ');
        } else {
          // è°ƒç”¨æ–°å¢æ¥å£ï¼šPOST /api/admin/roots
          await dictionaryApi.createRoot(form.value);
          ElMessage.success('æ–°å¢æˆåŠŸ');
        }
        
        dialogVisible.value = false;
        await fetchRoots(); // åˆ·æ–°åˆ—è¡¨
      } catch (error: any) {
        // å¦‚æœåç«¯è¿”å›é”™è¯¯ï¼Œè¿™é‡Œä¼šæ•è·å¹¶æç¤º
        // æŠ¥é”™â€œé‡å¤é”®â€é€šå¸¸å°±æ˜¯å› ä¸ºè¿™é‡Œè¯¯èµ°äº† createRoot é€»è¾‘
        console.error(error);
      } finally {
        submitting.value = false;
      }
    }
  });
};

onMounted(fetchRoots);
</script>

<style scoped>
.toolbar {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
}

.en-code {
  background: #f4f4f5;
  color: #409eff;
  padding: 2px 6px;
  border-radius: 4px;
  font-family: monospace;
}

.root-container {
  padding: 10px;
}
</style>
</file>

<file path="src/views/UserSearch.vue">
<template>
  <div class="user-nav">
</div>
  <div class="user-search-container">
    <div class="search-header">
      <h1>æ•°æ®æ ‡å‡†å­—å…¸æŸ¥è¯¢</h1>
      <p>æœç´¢å·²å®šä¹‰çš„æ ‡å‡†å­—æ®µï¼Œç¡®ä¿ç ”å‘å‘½åè§„èŒƒç»Ÿä¸€</p>
    </div>

    <div class="search-main">
      <el-input
        v-model="queryText"
        placeholder="è¾“å…¥ä¸­æ–‡å­—æ®µåç§° (å¦‚: æ‰‹æœºå·, å®¢æˆ·åç§°)"
        size="large"
        clearable
        @keyup.enter="doSearch"
      >
        <template #append>
          <el-button :icon="Search" @click="doSearch">æœç´¢</el-button>
        </template>
      </el-input>

      <div class="result-list" v-loading="loading">
        <template v-if="results.length > 0">
          <el-card v-for="item in results" :key="item.id" class="result-item">
            <div class="item-content">
              <div class="info">
                <div class="cn-name">{{ item.field_cn_name }}</div>
                <div class="en-name">{{ item.field_en_name }}</div>
              </div>
              <div class="meta">
                <el-tag size="small">{{ item.data_type }}</el-tag>
                <div class="time">å‘å¸ƒäº {{ new Date(item.created_at).toLocaleDateString() }}</div>
              </div>
            </div>
          </el-card>
        </template>

        <div v-if="results.length === 0 && similarRoots.length > 0" class="recommend-box">
        <el-alert title="æœªæ‰¾åˆ°ç²¾å‡†æ ‡å‡†å­—æ®µï¼Œä¸ºæ‚¨æ¨èç›¸å…³æ ‡å‡†è¯æ ¹ï¼š" type="info" show-icon :closable="false" />
        <div class="similar-list">
          <el-card v-for="root in similarRoots" :key="root.id" class="root-mini-card" shadow="hover">
            <div class="flex-between">
              <span class="root-cn">{{ root.cn_name }}</span>
              <el-tag size="small">è¯­ä¹‰åŒ¹é…åº¦ {{ (root.score * 100).toFixed(1) }}%</el-tag>
            </div>
            <code class="root-en">{{ root.en_abbr }}</code>
          </el-card>
        </div>
      </div>

        <el-empty v-else-if="hasSearched" description="æœªæ‰¾åˆ°æ ‡å‡†å®šä¹‰">
          <p class="empty-tip">è¯·è”ç³»ç®¡ç†å‘˜åœ¨åå°æ–°å¢æ­¤æ ‡å‡†å­—æ®µ</p>
          <el-button type="primary" plain @click="requestNew">æäº¤æ–°å¢ç”³è¯·</el-button>
        </el-empty>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';
import { Search } from '@element-plus/icons-vue';
import { dictionaryApi } from '../api';
import { ElMessage } from 'element-plus';

const queryText = ref('');
const loading = ref(false);
const results = ref<any[]>([]);
const hasSearched = ref(false);

const similarRoots = ref<any[]>([]);

const doSearch = async () => {
  if (!queryText.value) return;
  loading.value = true;
  results.value = [];
  similarRoots.value = [];
  
  try {
    // A. å…ˆæŸ¥æ ‡å‡†å­—æ®µ (Postgres ILIKE)
    const { data: fieldData } = await dictionaryApi.searchField(queryText.value);
    results.value = fieldData;

    // B. å¦‚æœå­—æ®µæŸ¥ä¸åˆ°ï¼Œç«‹å³å¯åŠ¨è¯­ä¹‰æœç´¢è¯æ ¹ (Qdrant)
    if (fieldData.length === 0) {
      // å‡è®¾æˆ‘ä»¬ä½¿ç”¨ä¹‹å‰å†™çš„ search-similar-roots æ¥å£
      const { data: simData } = await dictionaryApi.getSimilarRoots(queryText.value);
      similarRoots.value = simData;
    }
    
    hasSearched.value = true;
  } finally {
    loading.value = false;
  }
};

const requestNew = () => {
  ElMessage.success(`å·²è®°å½•ç”³è¯·: ${queryText.value}ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å¤„ç†`);
};
</script>

<style scoped>
.user-search-container { max-width: 700px; margin: 60px auto; }
.search-header { text-align: center; margin-bottom: 40px; }
.result-list { margin-top: 30px; }
.result-item { margin-bottom: 15px; transition: transform 0.2s; }
.result-item:hover { transform: translateY(-2px); border-color: #409eff; }
.item-content { display: flex; justify-content: space-between; align-items: center; }
.cn-name { font-size: 18px; font-weight: bold; margin-bottom: 4px; }
.en-name { font-family: 'Consolas', monospace; color: #409eff; font-weight: bold; }
.meta { text-align: right; }
.time { font-size: 12px; color: #999; margin-top: 8px; }
.user-nav { position: absolute; top: 20px; right: 20px; }
</style>
</file>

<file path="src/api/index.ts">
import axios from 'axios';
import router from '../router';
import type { WordRoot, SuggestResponse, StandardField, AuthPayload, AuthResponse } from '../types';
import { ElMessage } from 'element-plus';

const request = axios.create({
  baseURL: '/api', // Vite ä»£ç†ä¼šå°† /api è½¬å‘åˆ° http://127.0.0.1:3000
  timeout: 5000
});

// è¯·æ±‚æ‹¦æˆªå™¨ï¼šæ¯ç§’æ£€æŸ¥ä¸€æ¬¡æœ¬åœ°å­˜å‚¨ï¼Œå¦‚æœæœ‰ Token åˆ™æ³¨å…¥ Header
request.interceptors.request.use((config) => {
  const token = localStorage.getItem('token');
  if (token && config.headers) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// å“åº”æ‹¦æˆªå™¨ï¼šç»Ÿä¸€å¤„ç† 401/403 é”™è¯¯
request.interceptors.response.use(
  (res) => res,
  (err) => {
    if (err.response) {
      if (err.response.status === 401 || err.response.status === 403) {
        // åªè¦æ˜¯æƒé™æŠ¥é”™ï¼Œä¸ç®¡æ˜¯è¿‡æœŸè¿˜æ˜¯è¶Šæƒï¼Œä¸€å¾‹è§†ä½œâ€œå½“å‰ä¼šè¯å¤±æ•ˆâ€
        // ç«‹å³æ¸…é™¤æ‰€æœ‰æœ¬åœ°ç¼“å­˜å¹¶è·³å›ç™»å½•ï¼Œæ–¹ä¾¿ç”¨æˆ·æ¢å·ç™»å½•
        localStorage.clear();
        router.push('/login');
        ElMessage.error('æƒé™éªŒè¯å¤±è´¥ï¼Œè¯·ä½¿ç”¨ç®¡ç†å‘˜è´¦å·é‡æ–°ç™»å½•');
      } else {
        ElMessage.error(err.response.data || 'ç³»ç»Ÿé”™è¯¯');
      }
    }
    return Promise.reject(err);
  }
);

export const dictionaryApi = {
  // --- èº«ä»½è®¤è¯ (å¯¹åº”åç«¯ .nest("/api/auth", ...)) ---
  login: (data: AuthPayload) => request.post<AuthResponse>('/auth/login', data),
  signup: (data: AuthPayload) => request.post('/auth/signup', data),

  // --- å…¬å…±æŸ¥è¯¢ (å¯¹åº”åç«¯ .nest("/api/public", ...)) ---
  searchField: (q: string) => 
    request.get<StandardField[]>(`/public/search?q=${encodeURIComponent(q)}`),

  // --- ç®¡ç†ç«¯æ¥å£ (å¯¹åº”åç«¯ .nest("/api/admin", ...)) ---
  // è¯æ ¹ç®¡ç†
  getRoots: () => request.get<WordRoot[]>('/admin/roots'),
  createRoot: (data: WordRoot) => request.post('/admin/roots', data),
  updateRoot: (id: number, data: WordRoot) => request.put(`/admin/roots/${id}`, data),
  deleteRoot: (id: number) => request.delete(`/admin/roots/${id}`),

  // æ™ºèƒ½å»ºè®®
  getSuggest: (q: string) => 
    request.get<SuggestResponse>(`/admin/suggest?q=${encodeURIComponent(q)}`),

  // æ ‡å‡†å­—æ®µç®¡ç†
  getFields: () => request.get<StandardField[]>('/admin/fields'),
  createField: (data: any) => request.post('/admin/fields', data),
  updateField: (id: number, data: any) => request.put(`/admin/fields/${id}`, data),
  deleteField: (id: number) => request.delete(`/admin/fields/${id}`),
  getFieldDetails: (id: number) => request.get<WordRoot[]>(`/admin/fields/${id}`),

    // ç”¨æˆ·ç®¡ç†æ¥å£
  getUsers: () => request.get<any[]>('/admin/users'),
  updateUserRole: (id: number, role: string) => request.put(`/admin/users/${id}`, { role }),
  deleteUser: (id: number) => request.delete(`/admin/users/${id}`),

    // ç®¡ç†å‘˜åˆ›å»ºç”¨æˆ·
  adminCreateUser: (data: any) => request.post('/admin/users', data),

  getSimilarRoots: (q: string) => 
  request.get<any[]>(`/public/similar-roots?q=${encodeURIComponent(q)}`),
};
</file>

</files>
